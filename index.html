<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Center Car • V3.3</title>

  <!-- React & ReactDOM (development για καθαρά errors) -->
  <script crossorigin="anonymous" src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin="anonymous" src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel (με JSX μεταγλώττιση στο browser) -->
  <script crossorigin="anonymous" src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- jsPDF + autotable -->
  <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{--bg:#f6f7f9;--card:#fff;--fg:#0f1115;--muted:#6b7280;--border:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}
    header{position:sticky;top:0;background:#ffffffcc;backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .container{max-width:1160px;margin:0 auto;padding:12px 16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{padding:10px 12px;border:1px solid var(--border);background:#fff;border-radius:12px;cursor:pointer}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .btn.green{background:#10b981;color:#fff;border-color:#10b981}
    .btn.red{background:#dc2626;color:#fff;border-color:#dc2626}
    .tabs button{padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:#fff}
    .tabs .active{background:#111;color:#fff;border-color:#111}
    .grid{display:grid;gap:16px}
    .grid2{grid-template-columns:repeat(2,1fr)}
    .grid3{grid-template-columns:repeat(3,1fr)}
    .grid4{grid-template-columns:repeat(4,1fr)}
    .card{background:var(--card);border-radius:16px;box-shadow:0 2px 6px rgba(0,0,0,.06);padding:16px;position:relative}
    .title{font-weight:700}
    .muted{color:var(--muted);font-size:12px}
    input,select,textarea{padding:8px 10px;border:1px solid var(--border);border-radius:12px;background:#fff}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    .pill{background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;padding:6px 10px;display:inline-block}
    .ok{color:#16a34a}.danger{color:#dc2626}
    .modal{position:fixed;inset:0;background:#0006;display:flex;align-items:center;justify-content:center;padding:16px}
    .modal .panel{background:#fff;max-width:960px;width:100%;border-radius:16px;padding:16px;max-height:85vh;overflow:auto}
  </style>
</head>
<body>
  <div id="root"></div>
  <div id="err" style="padding:12px; color:#b91c1c; font-family:system-ui"></div>

  <script>
    // Πιάνουμε ΟΛΑ τα λάθη και τα γράφουμε καθαρά
    window.addEventListener('error', function (e) {
      const box = document.getElementById('err');
      if (box) box.textContent = "JS Error: " + (e.message||'') +
        " @ " + (e.filename||'') + ":" + (e.lineno||0) + ":" + (e.colno||0);
    }, true);
    window.addEventListener('unhandledrejection', function (e) {
      const box = document.getElementById('err');
      if (box) box.textContent = "Promise Error: " + (e.reason && (e.reason.stack || e.reason.message || e.reason));
    });
  </script>

  <script type="text/babel" data-presets="env,react">
    const {useState,useEffect} = React;
    const STORAGE_KEY = "centercar-v33-owner-only";
    const uid = () => Math.random().toString(36).slice(2);
    const todayStr = () => new Date().toISOString().slice(0,10);
    const fmt = n => (n??0).toLocaleString("el-GR",{minimumFractionDigits:2,maximumFractionDigits:2});
    const parseNum = v => (isNaN(parseFloat(v))?0:parseFloat(v));
    const ym = d => { const t=new Date(d); if(isNaN(t)) return ""; return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`; };

    const defaultState = {
      profile:{ ownerName:"Άγγελος", collaborators:["Άγγελος","Χρήστος","Γιάννης"], monthlyPersonalCap:800, reportMode:"cash" },
      capital:{ personal: 0, ledger: [] },
      freeLog: [],
      vehicles: [],
      expenses: [],
      ui:{ modal:null, modalData:null },
    };

    function App(){
      const [state,setState] = useState(()=>{
        try{ const raw=localStorage.getItem(STORAGE_KEY); return raw? JSON.parse(raw): defaultState; }
        catch(e){ return defaultState; }
      });
      const [tab,setTab] = useState("dashboard");
      const [reportMonth,setReportMonth] = useState(ym(todayStr()));
      useEffect(()=>{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); },[state]);

      const ownerName = state.profile.ownerName || "Άγγελος";
      const getVehicle = id => state.vehicles.find(v=>v.id===id);
      const vehicleExpensesTotal = (vid) => state.expenses.filter(e=>e.type==="vehicle" && e.vehicleId===vid).reduce((a,b)=>a+(b.amount||0),0);
      const vehicleCommittedCapital = (v) => v.partners.reduce((a,p)=>a+(p.capital||0),0);
      const sumPurchasesAll = state.vehicles.filter(v=>!v.customerVehicle).reduce((a,v)=>a+parseNum(v.purchasePrice||0),0);

      const grossProfit = (v) => parseNum(v.sale?.price) - parseNum(v.purchasePrice) - vehicleExpensesTotal(v.id);
      const capitalBasis = (v)=> parseNum(v.purchasePrice) + vehicleExpensesTotal(v.id);

      const ownerShareCapital = (v)=>{
        const tot = v.partners.reduce((a,p)=>a+(+p.capital||0),0);
        const own = v.partners.find(p=>p.name===ownerName)?.capital||0;
        return tot>0 ? own/tot : 1;
      };
      const profitOwnerShare = (v)=> (v.partners.length<=1 ? 1 : 0.5);

      const collectedCapitalOwner = (v) =>
        (v.sale?.collections||[]).filter(c=>c.type==="capital" && (c.recipient??ownerName)===ownerName).reduce((a,b)=>a+parseNum(b.amount||0),0);
      const collectedProfitOwner = (v) =>
        (v.sale?.collections||[]).filter(c=>c.type==="profit" && (c.recipient??ownerName)===ownerName).reduce((a,b)=>a+parseNum(b.amount||0),0);

      const ownerCapitalTarget = (v)=> capitalBasis(v) * ownerShareCapital(v);
      const ownerProfitTarget  = (v)=> Math.max(0, grossProfit(v)) * profitOwnerShare(v);

      const ownerOutstandingCapital = (v)=> Math.max(0, ownerCapitalTarget(v) - collectedCapitalOwner(v));
      const ownerOutstandingProfit  = (v)=> Math.max(0, ownerProfitTarget(v)  - collectedProfitOwner(v));

      const totalOwnerCommitted = state.vehicles.reduce((s,v)=> s + (v.partners.find(p=>p.name===ownerName)?.capital||0), 0);

      const personalNet = state.capital.personal +
        state.capital.ledger.reduce((s,l)=> s + (l.type==="in"? +1 : -1) * (l.amount||0), 0);

      const paidOverheads = state.expenses.filter(e=>e.type==="overhead" && e.status==="paid");
      const computeFreeCapital = () => {
        let free = parseNum(personalNet);
        state.vehicles.forEach(v=>{
          const ag = v.partners.find(p=>p.name===ownerName);
          if(ag) free -= parseNum(ag.capital||0);
        });
        paidOverheads.forEach(e=>{ if(e.whoPaid===ownerName) free -= parseNum(e.amount||0); });
        state.expenses.filter(e=>e.type==="vehicle" && e.status==="paid" && e.whoPaid===ownerName).forEach(e=> free -= parseNum(e.amount||0));
        state.vehicles.forEach(v=>{
          (v.sale?.collections||[]).forEach(c=>{
            const mine = (c.recipient??ownerName)===ownerName;
            if(!mine) return;
            if(c.destination?.type==="free"){
              free += parseNum(c.amount||0);
            } else if(c.destination?.type==="split"){
              const toVeh = parseNum(c.destination.toVehicleAmount||0);
              const rest = Math.max(0, parseNum(c.amount||0) - toVeh);
              const restDest = c.destination?.restDest || "free";
              if(rest>0 && restDest==="free"){ free += rest; }
            }
          });
        });
        return free;
      };
      const freeCapital = computeFreeCapital();

      const currentYM = ym(todayStr());
      const monthlyPersonalSpend = (yyyymm=currentYM) =>
        state.expenses.filter(e => e.type==="overhead" && e.category==="personal" && ym(e.date)===yyyymm)
                      .reduce((s,e)=> s + parseNum(e.amount||0), 0);

      const totalOwnerOutstandingProfit = state.vehicles.reduce((s,v)=> s + ownerOutstandingProfit(v), 0);
      const totalPersonalOverview = totalOwnerCommitted + freeCapital + totalOwnerOutstandingProfit;

      const logFree = (ev) => setState(s=>({...s, freeLog:[{id:uid(), date:ev.date||todayStr(), ...ev}, ...s.freeLog]}));
      const addCapitalLedger = (entry) => setState(s=>({...s, capital:{...s.capital, ledger:[{id:uid(),...entry}, ...s.capital.ledger]}}));

      const addVehicle = (v) => setState(s=>({...s, vehicles:[{
        id:uid(), title:v.title, vin:v.vin, purchasePrice:parseNum(v.purchasePrice), purchaseDate: v.purchaseDate||todayStr(),
        customerVehicle: !!v.customerVehicle, clientBudget: parseNum(v.clientBudget||0),
        isTradeIn: !!v.isTradeIn, tradeInOf: v.tradeInOf || null,
        partners: v.partners?.length? v.partners.map(p=>({...p,capital:parseNum(p.capital)})) : [{name:ownerName,capital:0}],
        sale:{ price:0,date:"",settled:false,collections:[],tradeIn:{enabled:false}}
      }, ...s.vehicles]}));

      const updateVehiclePartners = (vid, partners) =>
        setState(s=>({...s, vehicles: s.vehicles.map(v=> v.id===vid? {...v, partners: partners.map(p=>({...p,capital:parseNum(p.capital)})) } : v)}));

      const commitToVehicle   = (vid, amount) =>
        setState(s=>({...s, vehicles: s.vehicles.map(v=>{
          if(v.id!==vid) return v;
          const idx=v.partners.findIndex(p=>p.name===ownerName);
          const partners=[...v.partners];
          if(idx<0) partners.push({name:ownerName,capital:0});
          const prev = idx<0? 0 : parseNum(partners[idx].capital||0);
          partners[idx<0?partners.length-1:idx] = {name:ownerName, capital: prev + parseNum(amount)};
          logFree({amount:-Math.abs(parseNum(amount)), kind:"commit", ref:v.title, details:"Δέσμευση σε όχημα"});
          return {...v, partners};
        })}));

      const releaseFromVehicle = (vid, amount) =>
        setState(s=>({...s, vehicles: s.vehicles.map(v=>{
          if(v.id!==vid) return v;
          const partners = v.partners.map(p=> p.name!==ownerName? p : {...p, capital: Math.max(0, parseNum(p.capital||0)-parseNum(amount))});
          logFree({amount:+Math.abs(parseNum(amount)), kind:"release", ref:v.title, details:"Αποδέσμευση από όχημα"});
          return {...v, partners};
        })}));

      const addExpenseVehicle = (e) =>
        setState(s=>{
          const rec = {id:uid(), type:"vehicle", vehicleId:e.vehicleId, amount:parseNum(e.amount), date:e.date||todayStr(), note:e.note, whoPaid:e.whoPaid||ownerName, status:e.status||"unpaid"};
          if(rec.status==="paid" && rec.whoPaid===ownerName){
            logFree({amount:-Math.abs(parseNum(rec.amount)), kind:"veh_expense", ref:getVehicle(rec.vehicleId)?.title||"", details:rec.note||"Έξοδο οχήματος"});
          }
          return ({...s, expenses:[rec, ...s.expenses]});
        });

      const addOverhead = (e) =>
        setState(s=>{
          const rec = {id:uid(), type:"overhead", category:e.category, amount:parseNum(e.amount), date:e.date||todayStr(), note:e.note, whoPaid:e.whoPaid||ownerName, status:e.status||"unpaid", dueDate:e.dueDate||""};
          if(rec.status==="paid" && rec.whoPaid===ownerName && rec.category==="personal"){
            logFree({amount:-Math.abs(parseNum(rec.amount)), kind:"personal", ref:"Προσωπικά", details:rec.note||"Προσωπικό έξοδο"});
          }
          return ({...s, expenses:[rec, ...s.expenses]});
        });

      const markExpensePaid = (id) => setState(s=>{
        const rec = s.expenses.find(x=>x.id===id);
        let expenses = s.expenses.map(x=> x.id===id? {...x, status:"paid"} : x);
        if(rec && rec.whoPaid===ownerName){
          if(rec.type==="overhead" && rec.category==="personal"){
            logFree({amount:-Math.abs(parseNum(rec.amount)), kind:"personal", ref:"Προσωπικά", details:rec.note||"Προσωπικό έξοδο"});
          } else if(rec.type==="vehicle"){
            logFree({amount:-Math.abs(parseNum(rec.amount)), kind:"veh_expense", ref:getVehicle(rec.vehicleId)?.title||"", details:rec.note||"Έξοδο οχήματος"});
          }
        }
        return ({...s, expenses});
      });
      const deleteExpense   = (id) => setState(s=>({...s, expenses: s.expenses.filter(x=>x.id!==id)}));

      const recordSale = (vid, sale) =>
        setState(s=>({...s, vehicles: s.vehicles.map(v=> v.id===vid? {
          ...v, sale:{ ...v.sale, price:parseNum(sale.price), date: sale.date||todayStr(), settled: !!sale.settled, tradeIn: sale.tradeIn || v.sale.tradeIn }
        } : v)}));

      const addCollection = (vid, col) =>
        setState(s=>({...s, vehicles: s.vehicles.map(v=>{
          if(v.id!==vid) return v;
          const amount = parseNum(col.amount);
          const coll = {id:uid(), date: col.date||todayStr(), type: col.type, amount, destination: col.destination, recipient: ownerName};
          const collections=[coll, ...(v.sale?.collections||[])];

          if(col.destination?.type==="vehicle" && col.destination.vehicleId){
            setTimeout(()=>commitToVehicle(col.destination.vehicleId, amount),0);
          }
          if(col.destination?.type==="split"){
            const toVeh = parseNum(col.destination.toVehicleAmount||0);
            if(col.destination.vehicleId && toVeh>0){
              setTimeout(()=>commitToVehicle(col.destination.vehicleId, toVeh),0);
            }
            const rest = Math.max(0, amount - toVeh);
            const restDest = col.destination.restDest || "free";
            if(rest>0){
              if(restDest==="free"){
                logFree({amount:+rest, kind:"collect_free", ref:v.title, details:`Υπόλοιπο από split (${col.type})`});
              } else {
                const mapOver = {
                  "overhead_personal":"personal",
                  "overhead_home":"home",
                  "overhead_shop":"shop",
                  "overhead_other":"other",
                  "pocket":"personal"
                };
                const category = mapOver[restDest] || "personal";
                const note = `Από είσπραξη οχήματος ${v.title} (Split υπόλοιπο)`;
                setTimeout(()=>setState(ss=>({
                  ...ss,
                  expenses: [
                    { id:uid(), type:"overhead", category, amount:rest, date: col.date||todayStr(), note, whoPaid: ownerName, status:"paid" },
                    ...ss.expenses
                  ]
                })),0);
                if(category==="personal"){
                  logFree({amount:-rest, kind:"personal", ref:"Προσωπικά", details:note});
                }
              }
            }
          } else if(col.destination?.type==="free"){
            logFree({amount:+amount, kind:"collect_free", ref:v.title, details:`Είσπραξη ${col.type} → Free`});
          }
          return {...v, sale:{...v.sale, collections}};
        })}));

      const removeVehicle = (vid) => {
        const v = getVehicle(vid);
        if(!v) return;
        const agCommitted = (v.partners.find(p=>p.name===ownerName)?.capital || 0);
        const choice = prompt(`Διαγραφή οχήματος: ${v.title}\n\nΠληκτρολόγησε:\n- RETURN  → Επιστροφή δεσμευμένου κεφαλαίου στο Free\n- WIPE    → Πλήρης διαγραφή ΧΩΡΙΣ επιστροφή\n\n(Ακύρωση για έξοδο)`,"RETURN or WIPE");
        if(!choice) return;
        const norm = choice.trim().toLowerCase();
        if (norm.startsWith("wipe")) {
          setState(s=>({
            ...s,
            vehicles: s.vehicles.filter(x=>x.id!==vid),
            expenses: s.expenses.filter(e=> !(e.type==="vehicle" && e.vehicleId===vid))
          }));
        } else {
          if(agCommitted>0) logFree({amount:+agCommitted, kind:"release_delete", ref:v.title, details:"Διαγραφή με επιστροφή"});
          setState(s=>({
            ...s,
            vehicles: s.vehicles.filter(x=>x.id!==vid),
            expenses: s.expenses.filter(e=> !(e.type==="vehicle" && e.vehicleId===vid))
          }));
        }
      };

      const createTradeInFlow = (soldVehicleId, tradeData) => {
        const newId = uid();
        const partners = (tradeData.partners||[]).map(p=>({name:p.name, capital:parseNum(p.capital||0)}));
        const purchasePrice = partners.reduce((s,p)=>s+parseNum(p.capital||0),0);

        setState(s=>({
          ...s,
          vehicles: [{
            id:newId,
            title: tradeData.title || (`Trade-in από ${getVehicle(soldVehicleId)?.title||"—"}`),
            vin: tradeData.vin || "",
            purchasePrice,
            purchaseDate: tradeData.date || todayStr(),
            customerVehicle:false, clientBudget:0,
            isTradeIn:true, tradeInOf: soldVehicleId,
            partners,
            sale:{ price:0,date:"",settled:false,collections:[],tradeIn:{enabled:false}}
          }, ...s.vehicles]
        }));

        const amount = purchasePrice;
        const col = {
          date: tradeData.date || todayStr(),
          type: tradeData.source==="profit" ? "profit" : "capital",
          amount,
          destination:{type:"tradein", vehicleId:newId}
        };
        setTimeout(()=>addCollection(soldVehicleId, col), 0);
      };

      const toggleModal = (name=null, data=null) => setState(s=>({...s, ui:{modal:name, modalData:data}}));

      const exportJSON = () => {
        const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
        const url=URL.createObjectURL(blob); const a=document.createElement("a");
        a.href=url; a.download=`CenterCar-V33-${todayStr()}.json`; a.click(); URL.revokeObjectURL(url);
      };
      const importJSON = (file) => {
        if(!file) return;
        const r=new FileReader();
        r.onload=()=>{ try{setState(JSON.parse(r.result));}catch{alert("Μη έγκυρο JSON");}};
        r.readAsText(file);
      };
      const exportPDF = () => {
        const { jsPDF } = window.jspdf; const doc = new jsPDF({unit:"pt", format:"a4"}); const m=36; let y=m;
        doc.setFontSize(16); doc.text(`Center Car – Αναφορά (${new Date().toLocaleDateString("el-GR")})`, m,y); y+=18; doc.setFontSize(10);
        doc.autoTable({
          startY:y+6, head:[["Πεδίο","Τιμή"]],
          body:[
            ["Προσωπικό Κεφάλαιο (net)", `€ ${fmt(personalNet)}`],
            ["Ελεύθερο Κεφάλαιο (Free)", `€ ${fmt(freeCapital)}`],
            ["Δεσμευμένο Άγγελου σε οχήματα", `€ ${fmt(totalOwnerCommitted)}`],
            ["Συνολικό Προσωπικό Κεφάλαιο (Overview)", `€ ${fmt(totalPersonalOverview)}`],
            ["Συνολικό Budget σε Οχήματα (Αγορές)", `€ ${fmt(sumPurchasesAll)}`],
          ],
          theme:"grid", styles:{fontSize:9}, headStyles:{fillColor:[230,230,230]}, margin:{left:m,right:m}
        });
        doc.save(`CenterCar-Report-${todayStr()}.pdf`);
      };

      const [formV, setFormV] = useState({title:"",vin:"",purchasePrice:"",purchaseDate:"",customerVehicle:false,clientBudget:"", partners:[{name:ownerName, capital:0}]});
      const [formVehExp,setFormVehExp]=useState({vehicleId:"",amount:"",date:"",note:"",whoPaid:ownerName,status:"unpaid"});
      const [formOver,setFormOver]=useState({category:"personal",amount:"",date:"",note:"",whoPaid:ownerName,status:"unpaid",dueDate:""});

      const collaborators = state.profile.collaborators;

      return (
        <div>
          <header>
            <div className="container row" style={{justifyContent:"space-between"}}>
              <div className="row">
                <div className="title" style={{fontSize:20}}>Center Car • V3.3</div>
                <span className="pill">Owner-only Collections</span>
              </div>
              <div className="row">
                <button className="btn" onClick={exportJSON}>Εξαγωγή (JSON)</button>
                <label className="btn">Εισαγωγή (JSON)
                  <input type="file" accept="application/json" style={{display:"none"}} onChange={(e)=>importJSON(e.target.files?.[0])}/>
                </label>
                <button className="btn green" onClick={exportPDF}>Εξαγωγή PDF</button>
              </div>
            </div>

            <div className="container row tabs" style={{margin-bottom:8}}>
              {[
                ["dashboard","Πίνακας Ελέγχου"],
                ["vehicles","Οχήματα"],
                ["expenses","Έξοδα"],
                ["capital","Κεφάλαιο"],
                ["reports","Αναφορές"],
                ["sold","Πωλημένα"],
                ["settings","Ρυθμίσεις"],
              ].map(([k,gr])=>(
                <button key={k} className={tab===k?"active":""} onClick={()=>setTab(k)}>{gr}</button>
              ))}
            </div>
          </header>

          <main className="container" style={{padding:"20px 16px"}}>
            {tab==="dashboard" && (
              <section className="grid">
                <div className="grid grid4">
                  <CardStat label="Προσωπικό Κεφάλαιο (net)" value={`€ ${fmt(personalNet)}`} />
                  <CardStat label="Ελεύθερο Κεφάλαιο (Free)" value={`€ ${fmt(freeCapital)}`} />
                  <CardStat label="Δεσμευμένο Άγγελου σε οχήματα" value={`€ ${fmt(totalOwnerCommitted)}`} />
                  <CardStat label="Συνολικό Budget σε Οχήματα (Αγορές)" value={`€ ${fmt(sumPurchasesAll)}`} />
                </div>

                <div className="card">
                  <div className="title">Συνολικό Προσωπικό Κεφάλαιο</div>
                  <div style={{fontSize:24,fontWeight:700}}>€ {fmt(totalPersonalOverview)}</div>
                  <div className="muted">= Δεσμευμένο σου + Free + Αναμενόμενο Κέρδος (το δικό σου μερίδιο)</div>
                </div>

                <div className="card">
                  <div className="title">Προσωπικά έξοδα μήνα & όριο</div>
                  {(() => {
                    const cap = state.profile.monthlyPersonalCap || 0;
                    const spent = monthlyPersonalSpend(ym(todayStr()));
                    const remain = Math.max(0, cap - spent);
                    const over = Math.max(0, spent - cap);
                    return (
                      <div>
                        <div style={{fontSize:18, fontWeight:700}}>
                          Ξόδεψες: € {fmt(spent)} / Όριο: € {fmt(cap)}
                        </div>
                        {cap>0 && (
                          <div className="muted" style={{marginTop:6}}>
                            {spent<=cap
                              ? <>Σου μένουν € {fmt(remain)} για αυτόν τον μήνα.</>
                              : <span className="danger">Υπέρβαση ορίου: € {fmt(over)}</span>}
                          </div>
                        )}
                      </div>
                    );
                  })()}
                </div>
              </section>
            )}

            {tab==="vehicles" && (
              <section className="grid">
                <div className="card">
                  <div className="title">+ Προσθήκη Οχήματος</div>
                  <div className="grid grid4">
                    <input placeholder="Μοντέλο/Τίτλος" value={formV.title} onChange={e=>setFormV({...formV,title:e.target.value})}/>
                    <input placeholder="Πλαίσιο (VIN)" value={formV.vin} onChange={e=>setFormV({...formV,vin:e.target.value})}/>
                    <input type="number" placeholder="Τιμή Αγοράς" value={formV.purchasePrice} onChange={e=>setFormV({...formV,purchasePrice:e.target.value})}/>
                    <input type="date" value={formV.purchaseDate} onChange={e=>setFormV({...formV,purchaseDate:e.target.value})}/>
                  </div>
                  <div className="row" style={{marginTop:8}}>
                    <label><input type="checkbox" checked={!!formV.customerVehicle} onChange={e=>setFormV({...formV,customerVehicle:e.target.checked})}/> Όχημα Πελάτη</label>
                  </div>
                  <div className="card" style={{marginTop:8}}>
                    <div className="title">Συνεργάτες & Κεφάλαιο</div>
                    {formV.partners.map((p,i)=>(
                      <div key={i} className="row" style={{marginTop:6}}>
                        <select value={p.name} onChange={e=>{ const partners=[...formV.partners]; partners[i]={...partners[i], name:e.target.value}; setFormV({...formV,partners}); }}>
                          {collaborators.map(n=><option key={n}>{n}</option>)}
                        </select>
                        <input type="number" placeholder="Κεφάλαιο" value={p.capital} onChange={e=>{ const partners=[...formV.partners]; partners[i]={...partners[i], capital:e.target.value}; setFormV({...formV,partners}); }}/>
                        <button className="btn" onClick={()=>setFormV({...formV, partners: formV.partners.filter((_,j)=>j!==i)})}>Αφαίρεση</button>
                      </div>
                    ))}
                    <button className="btn" style={{marginTop:6}} onClick={()=>setFormV({...formV, partners:[...formV.partners,{name:ownerName,capital:0}]})}>+ Συνεργάτης</button>
                  </div>
                  <div style={{marginTop:8}}>
                    <button className="btn primary" onClick={()=>{
                      addVehicle(formV);
                      setFormV({title:"",vin:"",purchasePrice:"",purchaseDate:"",customerVehicle:false,clientBudget:"",partners:[{name:ownerName,capital:0}]});
                    }}>Προσθήκη</button>
                  </div>
                </div>
              </section>
            )}

            {tab==="expenses" && (
              <section className="grid">
                <div className="grid grid2">
                  <div className="card">
                    <div className="title">+ Γενικό Έξοδο (Overhead)</div>
                    <OverheadForm collaborators={collaborators} onAdd={(rec)=>addOverhead(rec)} />
                  </div>
                  <div className="card">
                    <div className="title">+ Έξοδο Οχήματος</div>
                    <VehicleExpenseForm vehicles={state.vehicles} collaborators={collaborators} onAdd={(rec)=>addExpenseVehicle(rec)} />
                  </div>
                </div>
                <ExpensesTables state={state} getVehicle={getVehicle} fmt={fmt} markPaid={markExpensePaid} delExp={deleteExpense}/>
              </section>
            )}

            {tab==="capital" && (
              <section className="grid">
                <div className="grid grid4">
                  <CardStat label="Προσωπικό Κεφάλαιο (net)" value={`€ ${fmt(personalNet)}`} />
                  <CardStat label="Ελεύθερο Κεφάλαιο (Free)" value={`€ ${fmt(freeCapital)}`} />
                  <CardStat label="Δεσμευμένο Άγγελου" value={`€ ${fmt(totalOwnerCommitted)}`} />
                  <CardStat label="Συνολικό Budget σε Οχήματα (Αγορές)" value={`€ ${fmt(sumPurchasesAll)}`} />
                </div>
                <div className="card">
                  <div className="title">+ Κίνηση Προσωπικού Κεφαλαίου</div>
                  <CapitalLedgerForm onAdd={(f)=>{
                    const entry = {date:f.date||todayStr(), type:f.type, amount:parseNum(f.amount), note: (f.dest==="free" ? "[to Free] " : "[to Personal] ") + (f.note||"")};
                    addCapitalLedger(entry);
                    if(f.dest==="free"){
                      const sign = f.type==="in" ? +1 : -1;
                      logFree({amount: sign*Math.abs(parseNum(f.amount)), kind:"capital_ledger", ref:"Κίνηση Κεφαλαίου", details:f.note||""});
                    }
                  }} />
                  <div className="muted" style={{marginTop:8}}>
                    * Το Free προκύπτει αυτόματα από το Προσωπικό + δεσμεύσεις/εισπράξεις/έξοδα (τα δικά σου).
                  </div>
                </div>
              </section>
            )}

            {tab==="reports" && (
              <section className="grid">
                <div className="card">
                  <div className="title">Μηνιαία Αναφορά</div>
                  <div className="row"><input type="month" value={reportMonth} onChange={e=>setReportMonth(e.target.value)} /></div>
                  <div className="grid grid3" style={{marginTop:8}}>
                    <div className="card">
                      <div className="title">Εισπραχθέν Κέρδος Ιδιοκτήτη (cash)</div>
                      <div style={{fontSize:24}}>
                        € {fmt(
                          state.vehicles.reduce((sum,v)=>{
                            const collectedThisMonth = (v.sale?.collections||[])
                              .filter(c=> c.type==="profit" && (c.recipient??ownerName)===ownerName && ym(c.date)===reportMonth)
                              .reduce((a,b)=>a+parseNum(b.amount||0),0);
                            return sum + collectedThisMonth;
                          },0)
                        )}
                      </div>
                      <div className="muted">Υπολογισμός: μόνο ό,τι εισπράττεις ΕΣΥ (50-50 εφαρμοσμένο).</div>
                    </div>
                    <div className="card">
                      <div className="title">Overheads του μήνα</div>
                      <table>
                        <thead><tr><th>Ημ/νία</th><th>Κατηγορία</th><th>Ποιος</th><th>Ποσό</th><th>Κατάσταση</th></tr></thead>
                        <tbody>
                          {state.expenses.filter(e=>e.type==="overhead" && ym(e.date)===reportMonth).map(e=>(
                            <tr key={e.id}><td>{e.date}</td><td>{e.category}</td><td>{e.whoPaid}</td><td>€ {fmt(e.amount)}</td><td>{e.status}</td></tr>
                          ))}
                          {state.expenses.filter(e=>e.type==="overhead" && ym(e.date)===reportMonth).length===0 &&
                            <tr><td colSpan="5" className="muted">Δεν υπάρχουν overheads.</td></tr>}
                        </tbody>
                      </table>
                    </div>
                    <div className="card">
                      <div className="title">Προσωπικά έξοδα (μήνας)</div>
                      {(() => {
                        const spent = monthlyPersonalSpend(reportMonth);
                        const cap = state.profile.monthlyPersonalCap || 0;
                        const over = Math.max(0, spent - cap);
                        return (
                          <div style={{fontSize:18}}>
                            Σύνολο: € {fmt(spent)}{cap>0 ? <> / Όριο: € {fmt(cap)} {over>0 && <span className="danger">(Υπέρβαση € {fmt(over)})</span>}</> : null}
                          </div>
                        );
                      })()}
                    </div>
                  </div>
                </div>
              </section>
            )}

            {tab==="sold" && (
              <section className="grid">
                <div className="card">
                  <div className="title">Πωλημένα Οχήματα (Αρχείο)</div>
                  <table>
                    <thead><tr>
                      <th>Όχημα</th><th>Αγορά</th><th>Έξοδα</th><th>Πώληση</th><th>Μικτό</th><th>Υπόλοιπα (Δικά σου)</th><th></th>
                    </tr></thead>
                    <tbody>
                      {state.vehicles.filter(v=>v.sale?.price>0).map(v=>{
                        const gp = grossProfit(v);
                        const outOwner = ownerOutstandingCapital(v)+ownerOutstandingProfit(v);
                        return (
                          <tr key={v.id}>
                            <td>{v.title}{v.isTradeIn && <div className="muted">Trade-in</div>}</td>
                            <td>€ {fmt(v.purchasePrice)}</td>
                            <td>€ {fmt(vehicleExpensesTotal(v.id))}</td>
                            <td>€ {fmt(v.sale.price)}<div className="muted">{v.sale.date}</div></td>
                            <td>€ {fmt(gp)}</td>
                            <td>€ {fmt(outOwner)}</td>
                            <td className="row">
                              <button className="btn red" onClick={()=>removeVehicle(v.id)}>Διαγραφή</button>
                            </td>
                          </tr>
                        );
                      })}
                      {state.vehicles.filter(v=>v.sale?.price>0).length===0 &&
                        <tr><td colSpan="7" className="muted">Δεν υπάρχουν πωλημένα ακόμη.</td></tr>}
                    </tbody>
                  </table>
                </div>
              </section>
            )}

            {tab==="settings" && (
              <section className="grid">
                <div className="card">
                  <div className="title">Προφίλ</div>
                  <div className="row" style={{marginTop:8}}>
                    <input value={state.profile.ownerName} onChange={e=>setState({...state, profile:{...state.profile, ownerName:e.target.value}})} placeholder="Όνομα Ιδιοκτήτη"/>
                    <input type="number" value={state.profile.monthlyPersonalCap} onChange={e=>setState({...state, profile:{...state.profile, monthlyPersonalCap: parseNum(e.target.value)}})} placeholder="Μηνιαίο Όριο Προσωπικών"/>
                    <select value={state.profile.reportMode} onChange={e=>setState({...state, profile:{...state.profile, reportMode:e.target.value}})}>
                      <option value="cash">Μετρητά (Cash)</option>
                      <option value="accrual">Λογιστική (Accrual)</option>
                    </select>
                  </div>
                </div>
                <div className="card">
                  <div className="title">Συνεργάτες</div>
                  <div className="row" style={{marginTop:8}}>{state.profile.collaborators.map((n,i)=><span key={i} className="pill">{n}</span>)}</div>
                </div>
              </section>
            )}
          </main>
        </div>
      );
    }

    const CardStat = ({label,value}) => (<div className="card"><div className="muted">{label}</div><div style={{fontSize:24,fontWeight:700}}>{value}</div></div>);

    const OverheadForm = ({collaborators,onAdd})=>{
      const [f,setF]=React.useState({category:"personal",amount:"",date:"",note:"",whoPaid:collaborators[0]||"Άγγελος",status:"unpaid",dueDate:""});
      return (
        <div className="row">
          <select value={f.category} onChange={e=>setF({...f,category:e.target.value})}>
            <option value="personal">Προσωπικά</option><option value="home">Σπίτι</option><option value="shop">Μαγαζί</option><option value="other">Άλλο</option>
          </select>
          <input type="number" placeholder="Ποσό" value={f.amount} onChange={e=>setF({...f,amount:e.target.value})}/>
          <input type="date" value={f.date} onChange={e=>setF({...f,date:e.target.value})}/>
          <select value={f.whoPaid} onChange={e=>setF({...f,whoPaid:e.target.value})}>{collaborators.map(n=><option key={n}>{n}</option>)}</select>
          <select value={f.status} onChange={e=>setF({...f,status:e.target.value})}><option value="unpaid">Απλήρωτο</option><option value="paid">Εξοφλημένο</option></select>
          <input type="date" value={f.dueDate} onChange={e=>setF({...f,dueDate:e.target.value})}/>
          <input placeholder="Σημείωση" value={f.note} onChange={e=>setF({...f,note:e.target.value})} style={{flex:1}}/>
          <button className="btn primary" onClick={()=>{ if(parseNum(f.amount)>0){ onAdd(f); setF({...f,amount:"",note:""}); } }}>Καταχώριση</button>
        </div>
      );
    };

    const VehicleExpenseForm = ({vehicles,collaborators,onAdd})=>{
      const [f,setF]=React.useState({vehicleId:"",amount:"",date:"",note:"",whoPaid:collaborators[0]||"Άγγελος",status:"unpaid"});
      return (
        <div className="row">
          <select value={f.vehicleId} onChange={e=>setF({...f,vehicleId:e.target.value})}>
            <option value="">— Επίλεξε Όχημα —</option>
            {vehicles.map(v=><option key={v.id} value={v.id}>{v.title}</option>)}
          </select>
          <input type="number" placeholder="Ποσό" value={f.amount} onChange={e=>setF({...f,amount:e.target.value})}/>
          <input type="date" value={f.date} onChange={e=>setF({...f,date:e.target.value})}/>
          <select value={f.whoPaid} onChange={e=>setF({...f,whoPaid:e.target.value})}>{collaborators.map(n=><option key={n}>{n}</option>)}</select>
          <select value={f.status} onChange={e=>setF({...f,status:e.target.value})}><option value="unpaid">Απλήρωτο</option><option value="paid">Εξοφλημένο</option></select>
          <input placeholder="Σημείωση" value={f.note} onChange={e=>setF({...f,note:e.target.value})}/>
          <button className="btn primary" onClick={()=>{ if(f.vehicleId && parseNum(f.amount)>0){ onAdd(f); setF({...f, vehicleId:"", amount:"", note:""}); } }}>Καταχώριση</button>
        </div>
      );
    };

    const ExpensesTables = ({state,getVehicle,fmt,markPaid,delExp})=>(
      <div className="grid grid2">
        <div className="card">
          <div className="title">Λίστα Γενικών Εξόδων</div>
          <table>
            <thead><tr><th>Ημ/νία</th><th>Κατηγορία</th><th>Ποιος</th><th>Ποσό</th><th>Σημ.</th><th>Κατάσταση</th><th></th></tr></thead>
            <tbody>
              {state.expenses.filter(e=>e.type==="overhead").map(e=>(
                <tr key={e.id}>
                  <td>{e.date}</td><td>{e.category}</td><td>{e.whoPaid}</td>
                  <td>€ {fmt(e.amount)}</td><td>{e.note}</td>
                  <td>{e.status==="paid"? <span className="ok">Εξοφλημένο</span> : <span className="danger">Απλήρωτο</span>}</td>
                  <td className="row">
                    {e.status!=="paid" && <button className="btn" onClick={()=>markPaid(e.id)}>Εξόφληση</button>}
                    <button className="btn" onClick={()=>delExp(e.id)}>Διαγραφή</button>
                  </td>
                </tr>
              ))}
              {state.expenses.filter(e=>e.type==="overhead").length===0 &&
                <tr><td colSpan="7" className="muted">Δεν υπάρχουν γενικά έξοδα ακόμη.</td></tr>}
            </tbody>
          </table>
        </div>

        <div className="card">
          <div className="title">Λίστα Εξόδων Οχημάτων</div>
          <table>
            <thead><tr><th>Ημ/νία</th><th>Όχημα</th><th>Ποιος</th><th>Ποσό</th><th>Σημείωση</th><th>Κατάσταση</th><th></th></tr></thead>
            <tbody>
              {state.expenses.filter(e=>e.type==="vehicle").map(e=>{
                const v=getVehicle(e.vehicleId);
                return (
                  <tr key={e.id}>
                    <td>{e.date}</td><td>{v?.title || "—"}</td><td>{e.whoPaid}</td>
                    <td>€ {fmt(e.amount)}</td><td>{e.note}</td>
                    <td>{e.status==="paid"? <span className="ok">Εξοφλημένο</span> : <span className="danger">Απλήρωτο</span>}</td>
                    <td className="row">
                      {e.status!=="paid" && <button className="btn" onClick={()=>markPaid(e.id)}>Εξόφληση</button>}
                      <button className="btn" onClick={()=>delExp(e.id)}>Διαγραφή</button>
                    </td>
                  </tr>
                );
              })}
              {state.expenses.filter(e=>e.type==="vehicle").length===0 &&
                <tr><td colSpan="7" className="muted">Δεν υπάρχουν έξοδα οχημάτων ακόμη.</td></tr>}
            </tbody>
          </table>
        </div>
      </div>
    );

    const CapitalLedgerForm = ({onAdd})=>{
      const [f,setF]=React.useState({date:"",type:"in",amount:"",note:"",dest:"free"});
      return (
        <div className="row">
          <input type="date" value={f.date} onChange={e=>setF({...f,date:e.target.value})}/>
          <select value={f.type} onChange={e=>setF({...f,type:e.target.value})}>
            <option value="in">Κατάθεση</option>
            <option value="out">Ανάληψη</option>
          </select>
          <select value={f.dest} onChange={e=>setF({...f,dest:e.target.value})}>
            <option value="free">Ελεύθερο (Free)</option>
            <option value="personal">Προσωπικό (Personal)</option>
          </select>
          <input type="number" placeholder="Ποσό" value={f.amount} onChange={e=>setF({...f,amount:e.target.value})}/>
          <input placeholder="Σημείωση" value={f.note} onChange={e=>setF({...f,note:e.target.value})} style={{flex:1}}/>
          <button className="btn primary" onClick={()=>{
            const amt = parseFloat(f.amount||0);
            if(amt>0){
              onAdd({ date: f.date || todayStr(), type: f.type, amount: amt, note: (f.dest==="free" ? "[to Free] " : "[to Personal] ") + (f.note||"") });
              setF({date:"",type:f.type,amount:"",note:"",dest:f.dest});
            }
          }}>Καταχώριση</button>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>
