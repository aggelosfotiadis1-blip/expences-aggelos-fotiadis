<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Center Car • V3.4 (Safe Import + Mobile)</title>

  <!-- React 18 + ReactDOM (UMD) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>

  <!-- Babel για inline JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>

  <!-- jsPDF + autotable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js" crossorigin="anonymous"></script>

  <style>
    :root{
      --bg:#f7f8fa; --card:#fff; --fg:#0f1115; --muted:#6b7280; --border:#e5e7eb;
      --brand:#111827; --ok:#10b981; --danger:#ef4444; --orange:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}
    header{position:sticky;top:0;z-index:10;background:#ffffffcc;backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .container{max-width:1040px;margin:0 auto;padding:12px 12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .spaced{justify-content:space-between}
    .btn{padding:10px 12px;border:1px solid var(--border);background:#fff;border-radius:12px;cursor:pointer;touch-action:manipulation}
    .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn.green{background:var(--ok);color:#fff;border-color:var(--ok)}
    .btn.red{background:var(--danger);color:#fff;border-color:var(--danger)}
    .btn.orange{background:var(--orange);color:#111;border-color:var(--orange)}
    .chip{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tabs .active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .grid{display:grid;gap:12px}
    @media (min-width:740px){ .grid2{grid-template-columns:1fr 1fr} .grid3{grid-template-columns:repeat(3,1fr)} .grid4{grid-template-columns:repeat(4,1fr)} }
    .card{background:var(--card);border-radius:16px;box-shadow:0 2px 6px rgba(0,0,0,.06);padding:14px;position:relative}
    .title{font-weight:700}
    .muted{color:var(--muted);font-size:12px}
    input,select,textarea{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;min-height:42px}
    input[type="date"], input[type="month"]{min-height:42px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    .money{font-variant-numeric:tabular-nums}
    .ok{color:var(--ok)} .danger{color:var(--danger)}
    .sticky-toolbar{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--border);padding:8px}
    .modal{position:fixed;inset:0;background:#0006;display:flex;align-items:flex-end;justify-content:center}
    @media (min-width:740px){ .modal{align-items:center} }
    .panel{background:#fff;max-width:960px;width:100%;border-radius:16px 16px 0 0;max-height:90vh;overflow:auto;padding:14px}
    @media (min-width:740px){ .panel{border-radius:16px} }
    /* iPhone safe bottom space */
    .safe-bottom{padding-bottom:calc(env(safe-area-inset-bottom,0) + 8px)}
    /* error strip */
    #err{color:#b91c1c;padding:8px 12px}
  </style>
</head>
<body>
  <div id="root"></div>
  <div id="err"></div>
  <script>
    // Δείξε ΟΝΤΟΛΟΓΗΜΕΝΟ error (όχι "Script error @ :0:0")
    window.addEventListener('error', function(ev){
      const box=document.getElementById('err');
      if(!box) return;
      let msg = "JS Error: " + (ev.error && ev.error.message ? ev.error.message : ev.message);
      if(ev.filename) msg += " @ " + ev.filename + ":" + ev.lineno + ":" + ev.colno;
      box.textContent = msg;
    });
    window.addEventListener('unhandledrejection', function(ev){
      const box=document.getElementById('err');
      if(!box) return;
      box.textContent = "Promise rejection: " + (ev.reason && ev.reason.message ? ev.reason.message : String(ev.reason));
    });
  </script>

  <script type="text/babel" data-presets="env,react">
  const {useState,useEffect,useMemo} = React;

  const STORAGE_KEY = "centercar-v34-safe";
  const uid   = ()=> Math.random().toString(36).slice(2);
  const today = ()=> new Date().toISOString().slice(0,10);
  const fmt   = n => (Number(n)||0).toLocaleString("el-GR",{minimumFractionDigits:2,maximumFractionDigits:2});
  const num   = v => isNaN(parseFloat(v))?0:parseFloat(v);
  const ym    = d => {const t=new Date(d); return isNaN(t)? "": `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`};

  // -------- helpers to fill defaults / migrate ----------
  const ensureArray = v => Array.isArray(v)? v: [];
  const safeVehicle = (v)=>({
    id: v.id || uid(),
    title: v.title || "",
    vin: v.vin || "",
    purchasePrice: num(v.purchasePrice||0),
    purchaseDate: v.purchaseDate || today(),
    customerVehicle: !!v.customerVehicle,
    clientBudget: num(v.clientBudget||0),
    isTradeIn: !!v.isTradeIn,
    tradeInOf: v.tradeInOf || null,
    partners: ensureArray(v.partners).map(p=>({name:p.name||"Άγγελος",capital:num(p.capital)})),
    sale: {
      price: num(v.sale?.price||0),
      date: v.sale?.date || "",
      settled: !!(v.sale?.settled),
      collections: ensureArray(v.sale?.collections).map(c=>({
        id: c.id || uid(),
        date: c.date || today(),
        type: (c.type==="capital"?"capital":"profit"),
        amount: num(c.amount||0),
        recipient: c.recipient || "Άγγελος",
        destination: c.destination ? {...c.destination} : {type:"free"}
      })),
      tradeIn: v.sale?.tradeIn ? {...v.sale.tradeIn} : {enabled:false}
    },
    deleted: !!v.deleted
  });

  const safeExpense = (e)=>({
    id: e.id || uid(),
    type: e.type==="vehicle" ? "vehicle" : "overhead",
    vehicleId: e.vehicleId || "",
    category: e.category || (e.type==="overhead" ? "personal" : ""),
    amount: num(e.amount||0),
    date: e.date || today(),
    note: e.note || "",
    whoPaid: e.whoPaid || "Άγγελος",
    status: e.status==="paid" ? "paid" : "unpaid",
    dueDate: e.dueDate || ""
  });

  const safeState = (src)=>{
    const base = {
      profile:{
        ownerName:"Άγγελος",
        collaborators:["Άγγελος","Χρήστος","Γιάννης"],
        monthlyPersonalCap:800,
        reportMode:"cash"
      },
      capital:{ personal: 0, ledger: [] },
      freeLog: [],
      vehicles: [],
      expenses: [],
      oldDebts: [],     // {id,title,partner,capital,profit,date,countAsCommitted:boolean, notes}
      deleted: { vehicles:[], expenses:[], oldDebts:[] },
      ui:{ modal:null, modalData:null }
    };
    const s = src && typeof src==="object" ? src : base;

    return {
      profile: {
        ownerName: s.profile?.ownerName || base.profile.ownerName,
        collaborators: ensureArray(s.profile?.collaborators).length ? s.profile.collaborators : base.profile.collaborators,
        monthlyPersonalCap: num(s.profile?.monthlyPersonalCap ?? base.profile.monthlyPersonalCap),
        reportMode: s.profile?.reportMode==="accrual"?"accrual":"cash"
      },
      capital: {
        personal: num(s.capital?.personal||0),
        ledger: ensureArray(s.capital?.ledger).map(l=>({
          id:l.id||uid(),
          date: l.date || today(),
          type: l.type==="out"?"out":"in",
          amount: num(l.amount||0),
          note: l.note || ""
        }))
      },
      freeLog: ensureArray(s.freeLog).map(r=>({
        id:r.id||uid(), date:r.date||today(), amount:num(r.amount||0),
        kind:r.kind||"manual", ref:r.ref||"", details:r.details||""
      })),
      vehicles: ensureArray(s.vehicles).map(safeVehicle),
      expenses: ensureArray(s.expenses).map(safeExpense),
      oldDebts: ensureArray(s.oldDebts).map(d=>({
        id:d.id||uid(),
        title:d.title||"",
        partner:d.partner||"Χρήστος",
        capital:num(d.capital||0),
        profit:num(d.profit||0),
        date:d.date||today(),
        countAsCommitted: !!d.countAsCommitted,
        notes:d.notes||""
      })),
      deleted:{
        vehicles: ensureArray(s.deleted?.vehicles).map(safeVehicle),
        expenses: ensureArray(s.deleted?.expenses).map(safeExpense),
        oldDebts: ensureArray(s.deleted?.oldDebts).map(d=>({
          id:d.id||uid(), title:d.title||"", partner:d.partner||"Χρήστος",
          capital:num(d.capital||0), profit:num(d.profit||0), date:d.date||today(),
          countAsCommitted: !!d.countAsCommitted, notes:d.notes||""
        }))
      },
      ui:{ modal:null, modalData:null }
    };
  };

  // ------------------- APP -----------------------
  function App(){
    const [state,setState] = useState(()=>{
      try{
        const raw=localStorage.getItem(STORAGE_KEY);
        return raw ? safeState(JSON.parse(raw)) : safeState();
      }catch(e){ return safeState(); }
    });
    const [tab,setTab] = useState("vehicles");
    const [reportMonth,setReportMonth] = useState(ym(today()));

    useEffect(()=>{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); },[state]);

    // ------- computed / helpers ----------
    const owner = state.profile.ownerName || "Άγγελος";
    const getVehicle = id => state.vehicles.find(v=>v.id===id);

    const vehicleExpensesTotal = (vid) =>
      state.expenses.filter(e=>e.type==="vehicle" && e.vehicleId===vid)
        .reduce((a,b)=>a+num(b.amount||0),0);

    const vehicleCommitted = (v)=> v.partners.reduce((s,p)=>s+num(p.capital||0),0);

    const grossProfit = (v)=> num(v.sale?.price) - num(v.purchasePrice) - vehicleExpensesTotal(v.id);

    const ownerShareCapital = (v)=>{
      const tot = v.partners.reduce((a,p)=>a+num(p.capital||0),0);
      const own = v.partners.find(p=>p.name===owner)?.capital||0;
      return tot>0 ? own/tot : 1;
    };
    const profitOwnerShare = (v)=> (v.partners.length<=1 ? 1 : 0.5);

    const collectedByOwner = (v,type)=>
      (v.sale?.collections||[]).filter(c=>c.type===type && (c.recipient??owner)===owner)
        .reduce((a,b)=>a+num(b.amount||0),0);

    const capitalBasis = (v)=> num(v.purchasePrice) + vehicleExpensesTotal(v.id);
    const ownerCapitalTarget = (v)=> capitalBasis(v) * ownerShareCapital(v);
    const ownerProfitTarget  = (v)=> Math.max(0, grossProfit(v)) * profitOwnerShare(v);

    const ownerOutstandingCapital = (v)=> Math.max(0, ownerCapitalTarget(v) - collectedByOwner(v,"capital"));
    const ownerOutstandingProfit  = (v)=> Math.max(0, ownerProfitTarget(v)  - collectedByOwner(v,"profit"));

    const totalOwnerCommittedVehicles =
      state.vehicles.reduce((s,v)=> s + (v.partners.find(p=>p.name===owner)?.capital||0), 0);

    const paidOverheadsMine = state.expenses
      .filter(e=>e.type==="overhead" && e.status==="paid" && e.whoPaid===owner)
      .reduce((s,e)=> s + num(e.amount||0), 0);

    const personalNet = state.capital.personal +
      state.capital.ledger.reduce((s,l)=> s + (l.type==="in"?+1:-1)*num(l.amount||0), 0);

    const computeFree = ()=>{
      // ανασύνθεση Free:
      let free = personalNet;
      // αφαιρώ δεσμεύσεις οχημάτων δικές μου
      state.vehicles.forEach(v=>{
        const mine = v.partners.find(p=>p.name===owner)?.capital||0;
        free -= num(mine);
      });
      // αφαιρώ έξοδα (mine) που πληρώθηκαν
      state.expenses.forEach(e=>{
        if(e.status==="paid" && e.whoPaid===owner){
          if(e.type==="overhead" && e.category==="personal") free -= num(e.amount||0);
          if(e.type==="vehicle") free -= num(e.amount||0);
        }
      });
      // προσθέτω εισπράξεις που πήγαν στο Free
      state.vehicles.forEach(v=>{
        (v.sale?.collections||[]).forEach(c=>{
          if((c.recipient??owner)!==owner) return;
          const amt=num(c.amount||0);
          const d=c.destination||{type:"free"};
          if(d.type==="free") free += amt;
          if(d.type==="split"){
            const toVeh=num(d.toVehicleAmount||0);
            const rest=Math.max(0, amt - toVeh);
            if((d.restDest||"free")==="free") free += rest;
          }
        });
      });
      // Old Debts που "μετράνε" ως δεσμευμένα: δεν αλλάζουν Free (εμφανίζονται στο committed)
      return free;
    };
    const freeCapital = computeFree();

    const oldDebtsCommitted = state.oldDebts
      .filter(d=>d.countAsCommitted)
      .reduce((s,d)=> s + num(d.capital||0), 0);

    const totalPersonalOverview = totalOwnerCommittedVehicles + oldDebtsCommitted + paidOverheadsMine + freeCapital;

    const logFree = (ev) =>
      setState(s=>({...s, freeLog:[{id:uid(), date:ev.date||today(), ...ev}, ...s.freeLog]}));

    // ---------------- actions (subset — σταθερά & ασφαλή) -------------
    const addVehicle = (v) =>
      setState(s=>({...s, vehicles:[ safeVehicle({
        ...v,
        partners: (v.partners?.length? v.partners : [{name:owner,capital:0}]).map(p=>({name:p.name||owner,capital:num(p.capital)}))
      }), ...s.vehicles]}));

    const updateVehiclePartners = (vid, partners) =>
      setState(s=>({...s, vehicles: s.vehicles.map(v=> v.id===vid? {...v, partners: partners.map(p=>({name:p.name,capital:num(p.capital)})) } : v)}));

    const commitToVehicle = (vid, amount) =>
      setState(s=>({...s, vehicles: s.vehicles.map(v=>{
        if(v.id!==vid) return v;
        const idx=v.partners.findIndex(p=>p.name===owner);
        const partners=[...v.partners];
        if(idx<0) partners.push({name:owner,capital:0});
        const pos = idx<0? partners.length-1 : idx;
        partners[pos] = {name:owner, capital: num(partners[pos].capital||0)+num(amount)};
        logFree({amount:-Math.abs(num(amount)), kind:"commit", ref:v.title, details:"Δέσμευση σε όχημα"});
        return {...v, partners};
      })}));

    const releaseFromVehicle = (vid, amount) =>
      setState(s=>({...s, vehicles: s.vehicles.map(v=>{
        if(v.id!==vid) return v;
        const partners=v.partners.map(p=> p.name!==owner ? p : {...p, capital: Math.max(0, num(p.capital||0)-num(amount))});
        logFree({amount:+Math.abs(num(amount)), kind:"release", ref:v.title, details:"Αποδέσμευση από όχημα"});
        return {...v, partners};
      })}));

    const addExpenseVehicle = (e) =>
      setState(s=>{
        const rec = safeExpense({...e, type:"vehicle"});
        let freeDelta = 0;
        if(rec.status==="paid" && rec.whoPaid===owner) freeDelta -= Math.abs(num(rec.amount));
        if(freeDelta) logFree({amount:freeDelta, kind:"veh_expense", ref:getVehicle(rec.vehicleId)?.title||"", details:rec.note||"Έξοδο οχήματος"});
        return ({...s, expenses:[rec, ...s.expenses]});
      });

    const addOverhead = (e) =>
      setState(s=>{
        const rec = safeExpense({...e, type:"overhead"});
        if(rec.status==="paid" && rec.whoPaid===owner && rec.category==="personal"){
          logFree({amount:-Math.abs(num(rec.amount)), kind:"personal", ref:"Προσωπικά", details:rec.note||"Προσωπικό έξοδο"});
        }
        return ({...s, expenses:[rec, ...s.expenses]});
      });

    const markExpensePaid = (id) => setState(s=>{
      const rec = s.expenses.find(x=>x.id===id);
      let expenses = s.expenses.map(x=> x.id===id? {...x, status:"paid"} : x);
      if(rec && rec.whoPaid===owner){
        if(rec.type==="overhead" && rec.category==="personal"){
          logFree({amount:-Math.abs(num(rec.amount)), kind:"personal", ref:"Προσωπικά", details:rec.note||"Προσωπικό έξοδο"});
        } else if(rec.type==="vehicle"){
          logFree({amount:-Math.abs(num(rec.amount)), kind:"veh_expense", ref:getVehicle(rec.vehicleId)?.title||"", details:rec.note||"Έξοδο οχήματος"});
        }
      }
      return ({...s, expenses});
    });

    const deleteExpense = (id) => setState(s=>{
      const rec = s.expenses.find(x=>x.id===id);
      return ({...s, expenses: s.expenses.filter(x=>x.id!==id), deleted:{...s.deleted, expenses:[rec?rec:[], ...s.deleted.expenses]}});
    });

    const recordSale = (vid, sale) =>
      setState(s=>({...s, vehicles: s.vehicles.map(v=> v.id===vid? {
        ...v, sale:{ ...v.sale, price:num(sale.price), date: sale.date||today(), settled: !!sale.settled, tradeIn: v.sale.tradeIn||{enabled:false} }
      } : v)}));

    const addCollection = (vid, col) =>
      setState(s=>({...s, vehicles: s.vehicles.map(v=>{
        if(v.id!==vid) return v;
        const amount = num(col.amount);
        const coll = {id:uid(), date: col.date||today(), type: col.type, amount, destination: col.destination, recipient: owner};
        const collections=[coll, ...(v.sale?.collections||[])];

        if(col.destination?.type==="vehicle" && col.destination.vehicleId){
          setTimeout(()=>commitToVehicle(col.destination.vehicleId, amount),0);
        }
        if(col.destination?.type==="split"){
          const toVeh=num(col.destination.toVehicleAmount||0);
          if(col.destination.vehicleId && toVeh>0){
            setTimeout(()=>commitToVehicle(col.destination.vehicleId, toVeh),0);
          }
          const rest=Math.max(0, amount - toVeh);
          const restDest=col.destination.restDest||"free";
          if(rest>0){
            if(restDest==="free"){
              logFree({amount:+rest, kind:"collect_free", ref:v.title, details:`Υπόλοιπο split (${col.type})`});
            } else {
              const map={overhead_personal:"personal", overhead_home:"home", overhead_shop:"shop", overhead_other:"other", pocket:"personal"};
              const category=map[restDest]||"personal";
              const note=`Από είσπραξη οχήματος ${v.title} (Split υπόλοιπο)`;
              setTimeout(()=>setState(ss=>({...ss, expenses:[ safeExpense({type:"overhead",category,amount:rest,date:col.date||today(),note,whoPaid:owner,status:"paid"}), ...ss.expenses ]})),0);
              if(category==="personal"){ logFree({amount:-rest, kind:"personal", ref:"Προσωπικά", details:note}); }
            }
          }
        } else if(col.destination?.type==="free"){
          logFree({amount:+amount, kind:"collect_free", ref:v.title, details:`Είσπραξη ${col.type} → Free`});
        }
        return {...v, sale:{...v.sale, collections}};
      })}));

    const removeVehicle = (vid) => setState(s=>{
      const v = s.vehicles.find(x=>x.id===vid);
      if(!v) return s;
      const others = s.vehicles.filter(x=>x.id!==vid);
      return ({...s, vehicles: others, deleted:{...s.deleted, vehicles:[v, ...s.deleted.vehicles]}});
    });

    const toggleSoldState = (vid, sold) =>
      setState(s=>({...s, vehicles: s.vehicles.map(v=> v.id===vid? {...v, sale:{...v.sale, settled: !!sold}} : v)}));

    // -------- Export / Import ----------
    const exportJSON = () => {
      const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
      const url=URL.createObjectURL(blob); const a=document.createElement("a");
      a.href=url; a.download=`CenterCar-V34-${today()}.json`; a.click(); URL.revokeObjectURL(url);
    };
    const exportPDF = () => {
      try{
        const { jsPDF } = window.jspdf; const doc = new jsPDF({unit:"pt",format:"a4"}); const m=36; let y=m;
        doc.setFontSize(16); doc.text(`Center Car – Αναφορά (${new Date().toLocaleDateString("el-GR")})`, m,y); y+=18; doc.setFontSize(10);
        doc.autoTable({
          startY:y+6, head:[["Πεδίο","Τιμή"]],
          body:[
            ["Προσωπικό Κεφάλαιο (net)", `€ ${fmt(personalNet)}`],
            ["Ελεύθερο Κεφάλαιο (Free)", `€ ${fmt(freeCapital)}`],
            ["Δεσμευμένο Άγγελου σε οχήματα", `€ ${fmt(totalOwnerCommittedVehicles)}`],
            ["Παλαιές Οφειλές (ως δεσμευμ.)", `€ ${fmt(oldDebtsCommitted)}`],
            ["Συνολικό Προσωπικό Κεφάλαιο (Overview)", `€ ${fmt(totalPersonalOverview)}`]
          ],
          theme:"grid", styles:{fontSize:9}, headStyles:{fillColor:[230,230,230]}, margin:{left:m,right:m}
        });
        doc.save(`CenterCar-Report-${today()}.pdf`);
      }catch(e){
        alert("PDF error: "+e.message);
      }
    };
    const importJSON = (file) => {
      if(!file) return;
      const reader=new FileReader();
      reader.onload=()=>{
        try{
          const raw = JSON.parse(String(reader.result||"{}"));
          const next = safeState(raw); // MIGRATION + defaults
          setState(next);
          document.getElementById('err').textContent="";
        }catch(e){
          document.getElementById('err').textContent = "Import failed: "+ e.message;
        }
      };
      reader.onerror=()=>{ document.getElementById('err').textContent = "Read error: "+(reader.error?.message||""); };
      reader.readAsText(file);
    };

    // -------------- UI --------------
    return (
      <div>
        <header>
          <div className="container row spaced">
            <div className="row">
              <div className="title" style={{fontSize:20}}>Center Car • V3.4</div>
              <span className="chip">Safe Import + Mobile</span>
            </div>
            <div className="row">
              <button className="btn" onClick={exportJSON}>Εξαγωγή (JSON)</button>
              <label className="btn">Εισαγωγή (JSON)
                <input type="file" accept="application/json" style={{display:"none"}} onChange={(e)=>importJSON(e.target.files?.[0])}/>
              </label>
              <button className="btn green" onClick={exportPDF}>Εξαγωγή PDF</button>
            </div>
          </div>
          <div className="container tabs">
            {[
              ["dashboard","Πίνακας Ελέγχου"],
              ["vehicles","Οχήματα"],
              ["expenses","Έξοδα"],
              ["olddebts","Παλιές Οφειλές"],
              ["sold","Πωλημένα"],
              ["deleted","Διαγραμμένα"],
              ["settings","Ρυθμίσεις"],
            ].map(([k,gr])=>(
              <button key={k} className={"btn "+(tab===k?"active":"")} onClick={()=>setTab(k)}>{gr}</button>
            ))}
          </div>
        </header>

        <main className="container" style={{padding:"16px 12px"}}>
          {tab==="dashboard" && (
            <section className="grid grid4">
              <CardStat label="Προσωπικό Κεφάλαιο (net)" value={`€ ${fmt(personalNet)}`}/>
              <CardStat label="Ελεύθερο (Free)" value={`€ ${fmt(freeCapital)}`}/>
              <CardStat label="Δεσμευμένο σε οχήματα" value={`€ ${fmt(totalOwnerCommittedVehicles)}`}/>
              <CardStat label="Παλ. οφειλές (ως δεσμευμ.)" value={`€ ${fmt(oldDebtsCommitted)}`}/>
              <div className="card" style={{gridColumn:"1 / -1"}}>
                <div className="title">Συνολικό Προσωπικό Κεφάλαιο</div>
                <div style={{fontSize:22,fontWeight:700}} className="money">€ {fmt(totalPersonalOverview)}</div>
                <div className="muted">= Δεσμευμένο σου + Παλ. οφειλές (αν μετράνε) + Προσωπικά έξοδα (πληρωμένα/δικά σου) + Free</div>
              </div>
            </section>
          )}

          {tab==="vehicles" && (
            <VehiclesTab
              state={state}
              owner={owner}
              fmt={fmt}
              getVehicle={getVehicle}
              vehicleExpensesTotal={vehicleExpensesTotal}
              ownerOutstandingCapital={ownerOutstandingCapital}
              ownerOutstandingProfit={ownerOutstandingProfit}
              addVehicle={addVehicle}
              updateVehiclePartners={updateVehiclePartners}
              commitToVehicle={commitToVehicle}
              releaseFromVehicle={releaseFromVehicle}
              addExpenseVehicle={addExpenseVehicle}
              recordSale={recordSale}
              addCollection={addCollection}
              removeVehicle={removeVehicle}
              toggleSoldState={toggleSoldState}
            />
          )}

          {tab==="expenses" && (
            <ExpensesTab
              state={state}
              owner={owner}
              fmt={fmt}
              addOverhead={addOverhead}
              addExpenseVehicle={addExpenseVehicle}
              markExpensePaid={markExpensePaid}
              deleteExpense={deleteExpense}
              getVehicle={getVehicle}
            />
          )}

          {tab==="olddebts" && (
            <OldDebtsTab state={state} setState={setState} fmt={fmt}/>
          )}

          {tab==="sold" && (
            <SoldTab state={state} fmt={fmt} toggleSoldState={toggleSoldState} getVehicle={getVehicle}/>
          )}

          {tab==="deleted" && (
            <DeletedTab state={state} setState={setState} fmt={fmt}/>
          )}

          {tab==="settings" && (
            <SettingsTab state={state} setState={setState}/>
          )}
        </main>
      </div>
    );
  }

  // ---------- Small components ----------
  const CardStat = ({label,value}) => (
    <div className="card"><div className="muted">{label}</div><div style={{fontSize:22,fontWeight:700}} className="money">{value}</div></div>
  );

  function VehiclesTab(props){
    const {
      state, owner, fmt, getVehicle, vehicleExpensesTotal,
      ownerOutstandingCapital, ownerOutstandingProfit,
      addVehicle, updateVehiclePartners, commitToVehicle, releaseFromVehicle,
      addExpenseVehicle, recordSale, addCollection, removeVehicle, toggleSoldState
    } = props;

    const [formV, setFormV] = React.useState({title:"",vin:"",purchasePrice:"",purchaseDate:"",customerVehicle:false,clientBudget:"", partners:[{name:owner, capital:0}]});

    return (
      <section className="grid">
        <div className="card">
          <div className="title">+ Προσθήκη Οχήματος</div>
          <div className="grid grid4">
            <input placeholder="Μοντέλο/Τίτλος" value={formV.title} onChange={e=>setFormV({...formV,title:e.target.value})}/>
            <input placeholder="VIN" value={formV.vin} onChange={e=>setFormV({...formV,vin:e.target.value})}/>
            <input type="number" placeholder="Τιμή Αγοράς" value={formV.purchasePrice} onChange={e=>setFormV({...formV,purchasePrice:e.target.value})}/>
            <input type="date" value={formV.purchaseDate} onChange={e=>setFormV({...formV,purchaseDate:e.target.value})}/>
          </div>
          <label className="row" style={{marginTop:6}}>
            <input type="checkbox" checked={!!formV.customerVehicle} onChange={e=>setFormV({...formV,customerVehicle:e.target.checked})}/> Όχημα Πελάτη
          </label>
          <div className="card" style={{marginTop:8}}>
            <div className="title">Συνεργάτες & Κεφάλαιο</div>
            {formV.partners.map((p,i)=>(
              <div key={i} className="row" style={{marginTop:6}}>
                <select value={p.name} onChange={e=>{ const partners=[...formV.partners]; partners[i]={...partners[i], name:e.target.value}; setFormV({...formV,partners}); }}>
                  {state.profile.collaborators.map(n=><option key={n}>{n}</option>)}
                </select>
                <input type="number" placeholder="Κεφάλαιο" value={p.capital} onChange={e=>{ const partners=[...formV.partners]; partners[i]={...partners[i], capital:e.target.value}; setFormV({...formV,partners}); }}/>
                <button className="btn" onClick={()=>setFormV({...formV, partners: formV.partners.filter((_,j)=>j!==i)})}>Αφαίρεση</button>
              </div>
            ))}
            <button className="btn" style={{marginTop:6}} onClick={()=>setFormV({...formV, partners:[...formV.partners,{name:owner,capital:0}]})}>+ Συνεργάτης</button>
          </div>
          <div style={{marginTop:8}}>
            <button className="btn primary" onClick={()=>{
              addVehicle(formV);
              setFormV({title:"",vin:"",purchasePrice:"",purchaseDate:"",customerVehicle:false,clientBudget:"", partners:[{name:owner, capital:0}]});
            }}>Προσθήκη</button>
          </div>
        </div>

        <div className="card">
          <div className="title">Όλα τα Οχήματα</div>
          <table>
            <thead><tr>
              <th>Όχημα</th><th>Συνεργάτες (Κεφάλαιο)</th><th>Δεσμευμένο</th><th>Έξοδα</th>
              <th>Υπ. Κεφαλαίου (Δικό σου)</th><th>Υπ. Κέρδους (Δικό σου)</th><th>Πώληση</th><th>Δράσεις</th>
            </tr></thead>
            <tbody>
              {state.vehicles.filter(v=>!v.deleted && !v.sale?.settled).map(v=>(
                <tr key={v.id}>
                  <td>{v.title}{v.isTradeIn && <div className="muted">Trade-in</div>}<div className="muted">{v.vin||"—"}</div></td>
                  <td>{v.partners.map(p=><div key={p.name}>{p.name}: € {fmt(p.capital||0)}</div>)}</td>
                  <td>€ {fmt(vehicleCommitted(v))}</td>
                  <td>€ {fmt(vehicleExpensesTotal(v.id))}</td>
                  <td>€ {fmt(ownerOutstandingCapital(v))}</td>
                  <td>€ {fmt(ownerOutstandingProfit(v))}</td>
                  <td>{v.sale?.price? <>€ {fmt(v.sale.price)}<div className="muted">{v.sale.date}</div></> : "—"}</td>
                  <td className="row">
                    <button className="btn" onClick={()=>alert("Έξοδα: χρησιμοποίησε την καρτέλα 'Έξοδα' για καταχώριση/εμφάνιση.")}>Έξοδα</button>
                    <button className="btn" onClick={()=>alert("Συνεργάτες: άνοιξε 'Συνεργάτες & Κεφάλαιο' μέσω επεξεργασίας (σύντομα).")}>Συνεργάτες</button>
                    <button className="btn" onClick={()=> {
                      const price=prompt("Τιμή πώλησης (€):", v.sale?.price||"");
                      if(price===null) return;
                      const date=prompt("Ημερομηνία (YYYY-MM-DD):", v.sale?.date||today())||today();
                      const settled = confirm("Να μαρκαριστεί ως ΟΛΟΚΛΗΡΩΜΕΝΗ;");
                      recordSale(v.id,{price,date,settled});
                    }}>Πώληση</button>
                    <button className="btn" onClick={()=>{
                      const type=prompt("Τύπος: capital / profit","profit"); if(!type) return;
                      const amount=prompt("Ποσό (€):",""); if(!amount) return;
                      const dest=prompt("Προορισμός: free / vehicle / split","free")||"free";
                      let destination={type:"free"};
                      if(dest==="vehicle"){
                        const choices = state.vehicles.filter(x=>x.id!==v.id && !x.sale?.settled);
                        const vid = prompt("VehicleId από την λίστα (ή άκυρο):\n" + choices.map(x=>`${x.title} → ${x.id}`).join("\n"), "");
                        if(vid) destination={type:"vehicle", vehicleId:vid};
                      } else if(dest==="split"){
                        const choices = state.vehicles.filter(x=>x.id!==v.id && !x.sale?.settled);
                        const vid = prompt("VehicleId για το μέρος που θα πάει:", choices[0]?.id||"");
                        const toVehicleAmount = prompt("Ποσό προς όχημα (€):","0")||"0";
                        const restDest = prompt("Υπόλοιπο: free / overhead_personal / overhead_home / overhead_shop / overhead_other / pocket","free")||"free";
                        destination={type:"split", vehicleId:vid, toVehicleAmount, restDest};
                      }
                      addCollection(v.id,{type: (type==="capital"?"capital":"profit"), amount, date:today(), destination});
                    }}>Είσπραξη</button>
                    <button className="btn orange" onClick={()=> toggleSoldState(v.id,true)}>Μάρκαρε ΠΩΛΗΘΗΚΕ</button>
                    <button className="btn red" onClick={()=>removeVehicle(v.id)}>Διαγραφή</button>
                  </td>
                </tr>
              ))}
              {state.vehicles.filter(v=>!v.deleted && !v.sale?.settled).length===0 &&
                <tr><td colSpan="8" className="muted">Δεν υπάρχουν οχήματα.</td></tr>}
            </tbody>
          </table>
        </div>
      </section>
    );
  }

  function ExpensesTab({state,owner,fmt,addOverhead,addExpenseVehicle,markExpensePaid,deleteExpense,getVehicle}){
    const [formOver,setFormOver]=React.useState({category:"personal",amount:"",date:"",note:"",whoPaid:owner,status:"unpaid",dueDate:""});
    const [formVehExp,setFormVehExp]=React.useState({vehicleId:"",amount:"",date:"",note:"",whoPaid:owner,status:"unpaid"});

    return (
      <section className="grid grid2">
        <div className="card">
          <div className="title">+ Γενικό Έξοδο</div>
          <div className="row">
            <select value={formOver.category} onChange={e=>setFormOver({...formOver,category:e.target.value})}>
              <option value="personal">Προσωπικά</option>
              <option value="home">Σπίτι</option>
              <option value="shop">Μαγαζί</option>
              <option value="other">Άλλο</option>
            </select>
            <input type="number" placeholder="Ποσό" value={formOver.amount} onChange={e=>setFormOver({...formOver,amount:e.target.value})}/>
            <input type="date" value={formOver.date} onChange={e=>setFormOver({...formOver,date:e.target.value})}/>
            <select value={formOver.whoPaid} onChange={e=>setFormOver({...formOver,whoPaid:e.target.value})}>
              {state.profile.collaborators.map(n=><option key={n}>{n}</option>)}
            </select>
            <select value={formOver.status} onChange={e=>setFormOver({...formOver,status:e.target.value})}>
              <option value="unpaid">Απλήρωτο</option>
              <option value="paid">Εξοφλημένο</option>
            </select>
            <input type="date" value={formOver.dueDate} onChange={e=>setFormOver({...formOver,dueDate:e.target.value})} placeholder="Πληρωτέο"/>
            <input placeholder="Σημείωση" value={formOver.note} onChange={e=>setFormOver({...formOver,note:e.target.value})}/>
            <button className="btn primary" onClick={()=>{ if(num(formOver.amount)>0){ addOverhead(formOver); setFormOver({...formOver,amount:"",note:""}); } }}>Καταχώριση</button>
          </div>
        </div>

        <div className="card">
          <div className="title">+ Έξοδο Οχήματος</div>
          <div className="row">
            <select value={formVehExp.vehicleId} onChange={e=>setFormVehExp({...formVehExp,vehicleId:e.target.value})}>
              <option value="">— Επίλεξε Όχημα —</option>
              {state.vehicles.filter(v=>!v.deleted).map(v=><option key={v.id} value={v.id}>{v.title}</option>)}
            </select>
            <input type="number" placeholder="Ποσό" value={formVehExp.amount} onChange={e=>setFormVehExp({...formVehExp,amount:e.target.value})}/>
            <input type="date" value={formVehExp.date} onChange={e=>setFormVehExp({...formVehExp,date:e.target.value})}/>
            <select value={formVehExp.whoPaid} onChange={e=>setFormVehExp({...formVehExp,whoPaid:e.target.value})}>
              {state.profile.collaborators.map(n=><option key={n}>{n}</option>)}
            </select>
            <select value={formVehExp.status} onChange={e=>setFormVehExp({...formVehExp,status:e.target.value})}>
              <option value="unpaid">Απλήρωτο</option>
              <option value="paid">Εξοφλημένο</option>
            </select>
            <input placeholder="Σημείωση" value={formVehExp.note} onChange={e=>setFormVehExp({...formVehExp,note:e.target.value})}/>
            <button className="btn primary" onClick={()=>{ if(formVehExp.vehicleId && num(formVehExp.amount)>0){ addExpenseVehicle(formVehExp); setFormVehExp({...formVehExp, vehicleId:"", amount:"", note:""}); } }}>Καταχώριση</button>
          </div>
        </div>

        <div className="card" style={{gridColumn:"1 / -1"}}>
          <div className="title">Λίστα Εξόδων</div>
          <table>
            <thead><tr><th>Ημ/νία</th><th>Τύπος</th><th>Σχετικό</th><th>Ποιος</th><th>Ποσό</th><th>Σημείωση</th><th>Κατ.</th><th>Κατάσταση</th><th></th></tr></thead>
            <tbody>
              {state.expenses.map(e=>{
                const v=getVehicle(e.vehicleId);
                return (
                  <tr key={e.id}>
                    <td>{e.date}</td>
                    <td>{e.type}</td>
                    <td>{e.type==="vehicle"? (v?.title||"—") : "—"}</td>
                    <td>{e.whoPaid}</td>
                    <td>€ {fmt(e.amount)}</td>
                    <td>{e.note}</td>
                    <td>{e.type==="overhead"? e.category : "—"}</td>
                    <td>{e.status==="paid"? <span className="ok">paid</span> : <span className="danger">unpaid</span>}</td>
                    <td className="row">
                      {e.status!=="paid" && <button className="btn" onClick={()=>markExpensePaid(e.id)}>Εξόφληση</button>}
                      <button className="btn red" onClick={()=>deleteExpense(e.id)}>Διαγραφή</button>
                    </td>
                  </tr>
                );
              })}
              {state.expenses.length===0 && <tr><td colSpan="9" className="muted">Δεν υπάρχουν έξοδα.</td></tr>}
            </tbody>
          </table>
        </div>
      </section>
    );
  }

  function OldDebtsTab({state,setState,fmt}){
    const [f,setF]=React.useState({title:"",partner:"Χρήστος",capital:"",profit:"",date:"",countAsCommitted:true,notes:""});
    return (
      <section className="grid">
        <div className="card">
          <div className="title">+ Παλιά Οφειλή</div>
          <div className="row">
            <input placeholder="Όχημα/Περιγραφή" value={f.title} onChange={e=>setF({...f,title:e.target.value})}/>
            <select value={f.partner} onChange={e=>setF({...f,partner:e.target.value})}>
              {state.profile.collaborators.map(n=><option key={n}>{n}</option>)}
            </select>
            <input type="number" placeholder="Κεφάλαιο (€)" value={f.capital} onChange={e=>setF({...f,capital:e.target.value})}/>
            <input type="number" placeholder="Κέρδος (€)" value={f.profit} onChange={e=>setF({...f,profit:e.target.value})}/>
            <input type="date" value={f.date} onChange={e=>setF({...f,date:e.target.value})}/>
            <label><input type="checkbox" checked={!!f.countAsCommitted} onChange={e=>setF({...f,countAsCommitted:e.target.checked})}/> Μετράει ως δεσμευμένο</label>
            <input placeholder="Σημειώσεις" value={f.notes} onChange={e=>setF({...f,notes:e.target.value})} style={{flex:1}}/>
            <button className="btn primary" onClick={()=>{
              setState(s=>({...s, oldDebts:[{id:uid(), title:f.title, partner:f.partner, capital:num(f.capital), profit:num(f.profit), date:f.date||today(), countAsCommitted:!!f.countAsCommitted, notes:f.notes}, ...s.oldDebts]}));
              setF({title:"",partner:"Χρήστος",capital:"",profit:"",date:"",countAsCommitted:true,notes:""});
            }}>Καταχώριση</button>
          </div>
        </div>
        <div className="card">
          <div className="title">Λίστα Παλαιών Οφειλών</div>
          <table>
            <thead><tr><th>Ημ/νία</th><th>Τίτλος</th><th>Παρ.</th><th>Κεφάλαιο</th><th>Κέρδος</th><th>Μετράει ως δεσμευμ.</th><th>Σημ.</th><th></th></tr></thead>
            <tbody>
              {state.oldDebts.map(d=>(
                <tr key={d.id}>
                  <td>{d.date||"—"}</td>
                  <td>{d.title||"—"}</td>
                  <td>{d.partner}</td>
                  <td>€ {fmt(d.capital)}</td>
                  <td>€ {fmt(d.profit)}</td>
                  <td>{d.countAsCommitted? "Ναι":"Όχι"}</td>
                  <td>{d.notes}</td>
                  <td className="row">
                    <button className="btn" onClick={()=>{
                      const cap = prompt("Νέο κεφάλαιο (€):", d.capital); if(cap===null) return;
                      const prof= prompt("Νέο κέρδος (€):", d.profit); if(prof===null) return;
                      setState(s=>({...s, oldDebts: s.oldDebts.map(x=> x.id===d.id? {...x, capital:num(cap), profit:num(prof)} : x)}));
                    }}>Επεξεργασία</button>
                    <button className="btn red" onClick={()=> setState(s=>({...s, oldDebts: s.oldDebts.filter(x=>x.id!==d.id), deleted:{...s.deleted, oldDebts:[d, ...s.deleted.oldDebts]}}))}>Διαγραφή</button>
                  </td>
                </tr>
              ))}
              {state.oldDebts.length===0 && <tr><td colSpan="8" className="muted">Δεν υπάρχουν οφειλές.</td></tr>}
            </tbody>
          </table>
        </div>
      </section>
    );
  }

  function SoldTab({state,fmt,toggleSoldState,getVehicle}){
    const sold = state.vehicles.filter(v=>!v.deleted && v.sale?.settled);
    return (
      <section className="grid">
        <div className="card">
          <div className="title">Πωλημένα</div>
          <table>
            <thead><tr><th>Όχημα</th><th>Αγορά</th><th>Πώληση</th><th>Δράσεις</th></tr></thead>
            <tbody>
              {sold.map(v=>(
                <tr key={v.id}>
                  <td>{v.title}</td>
                  <td>€ {fmt(v.purchasePrice)}</td>
                  <td>{v.sale?.price? <>€ {fmt(v.sale.price)} <div className="muted">{v.sale.date}</div></> : "—"}</td>
                  <td className="row">
                    <button className="btn orange" onClick={()=> toggleSoldState(v.id,false)}>Δεν πουλήθηκε (Επαναφορά)</button>
                  </td>
                </tr>
              ))}
              {sold.length===0 && <tr><td colSpan="4" className="muted">Δεν υπάρχουν πωλημένα.</td></tr>}
            </tbody>
          </table>
        </div>
      </section>
    );
  }

  function DeletedTab({state,setState,fmt}){
    const restore = (kind,id)=>{
      setState(s=>{
        if(kind==="vehicle"){
          const item = s.deleted.vehicles.find(x=>x.id===id); if(!item) return s;
          return {...s, vehicles:[item, ...s.vehicles], deleted:{...s.deleted, vehicles:s.deleted.vehicles.filter(x=>x.id!==id)}};
        }
        if(kind==="expense"){
          const item = s.deleted.expenses.find(x=>x.id===id); if(!item) return s;
          return {...s, expenses:[item, ...s.expenses], deleted:{...s.deleted, expenses:s.deleted.expenses.filter(x=>x.id!==id)}};
        }
        if(kind==="olddebt"){
          const item = s.deleted.oldDebts.find(x=>x.id===id); if(!item) return s;
          return {...s, oldDebts:[item, ...s.oldDebts], deleted:{...s.deleted, oldDebts:s.deleted.oldDebts.filter(x=>x.id!==id)}};
        }
        return s;
      });
    };
    return (
      <section className="grid grid3">
        <div className="card">
          <div className="title">Διεγραμμένα Οχήματα</div>
          {state.deleted.vehicles.length===0 && <div className="muted">—</div>}
          {state.deleted.vehicles.map(v=>(
            <div key={v.id} className="row" style={{justifyContent:"space-between"}}>
              <div>{v.title}</div>
              <div className="row">
                <button className="btn" onClick={()=>restore("vehicle",v.id)}>Επαναφορά</button>
              </div>
            </div>
          ))}
        </div>
        <div className="card">
          <div className="title">Διεγραμμένα Έξοδα</div>
          {state.deleted.expenses.length===0 && <div className="muted">—</div>}
          {state.deleted.expenses.map(e=>(
            <div key={e.id} className="row" style={{justifyContent:"space-between"}}>
              <div>{e.type} — € {fmt(e.amount)} — {e.date}</div>
              <button className="btn" onClick={()=>restore("expense",e.id)}>Επαναφορά</button>
            </div>
          ))}
        </div>
        <div className="card">
          <div className="title">Διεγραμμένες Οφειλές</div>
          {state.deleted.oldDebts.length===0 && <div className="muted">—</div>}
          {state.deleted.oldDebts.map(d=>(
            <div key={d.id} className="row" style={{justifyContent:"space-between"}}>
              <div>{d.title} — € {fmt(d.capital)} / € {fmt(d.profit)}</div>
              <button className="btn" onClick={()=>restore("olddebt",d.id)}>Επαναφορά</button>
            </div>
          ))}
        </div>
      </section>
    );
  }

  function SettingsTab({state,setState}){
    return (
      <section className="grid">
        <div className="card">
          <div className="title">Προφίλ</div>
          <div className="row" style={{marginTop:6}}>
            <input value={state.profile.ownerName} onChange={e=>setState({...state, profile:{...state.profile, ownerName:e.target.value}})} placeholder="Όνομα Ιδιοκτήτη"/>
            <input type="number" value={state.profile.monthlyPersonalCap} onChange={e=>setState({...state, profile:{...state.profile, monthlyPersonalCap: num(e.target.value)}})} placeholder="Μηνιαίο Όριο Προσωπικών"/>
            <select value={state.profile.reportMode} onChange={e=>setState({...state, profile:{...state.profile, reportMode:e.target.value}})}>
              <option value="cash">Μετρητά (Cash)</option>
              <option value="accrual">Λογιστική (Accrual)</option>
            </select>
          </div>
          <div className="row" style={{marginTop:6}}>
            <button className="btn red" onClick={()=>{
              if(!confirm("Σίγουρα καθάρισμα δεδομένων; Θα κρατήσω μόνο ένα μίνι backup στο Deleted.")) return;
              localStorage.removeItem(STORAGE_KEY);
              location.reload();
            }}>Hard reset</button>
          </div>
        </div>
      </section>
    );
  }

  ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>
