<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Center Car • Stock & Capital V3.5</title>
<style>
  :root{
    --bg:#0f1115; --card:#171923; --muted:#a0aec0; --text:#e2e8f0; --accent:#3b82f6;
    --red:#ef4444; --green:#10b981; --yellow:#f59e0b; --outline:#2d3748;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
  header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,var(--bg),rgba(15,17,21,.85));backdrop-filter:saturate(120%) blur(6px);border-bottom:1px solid var(--outline)}
  .topbar{display:flex;gap:.5rem;align-items:center;justify-content:space-between;padding:.6rem .8rem;max-width:1100px;margin:0 auto}
  .brand{font-weight:700;letter-spacing:.4px}
  nav{display:flex;flex-wrap:wrap;gap:.35rem}
  nav button{border:1px solid var(--outline);background:var(--card);color:var(--text);padding:.5rem .7rem;border-radius:.6rem;cursor:pointer}
  nav button.active{outline:2px solid var(--accent)}
  .container{max-width:1100px;margin:0 auto;padding:1rem}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
  @media (max-width:800px){.row{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--outline);border-radius:.8rem;padding:1rem}
  h2,h3{margin:.2rem 0 .6rem 0}
  .muted{color:var(--muted)}
  .btn{display:inline-flex;align-items:center;gap:.4rem;padding:.5rem .7rem;border-radius:.6rem;border:1px solid var(--outline);background:var(--card);color:var(--text);cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:white}
  .btn.danger{background:var(--red);border-color:var(--red)}
  .btn.warn{background:var(--yellow);border-color:var(--yellow);color:black}
  .btn.ghost{background:transparent}
  input,select,textarea{width:100%;padding:.55rem .6rem;border-radius:.6rem;border:1px solid var(--outline);background:#0e1117;color:var(--text)}
  label{font-size:.85rem;color:var(--muted)}
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  th,td{text-align:left;padding:.5rem .6rem;border-bottom:1px dashed rgba(255,255,255,.06)}
  th{font-size:.85rem;color:var(--muted);font-weight:600}
  tr:hover td{background:#0e1117}

  .tag{display:inline-block;padding:.2rem .5rem;border:1px solid var(--outline);border-radius:999px;font-size:.8rem}
  .flex{display:flex;gap:.5rem;align-items:center}
  .right{justify-content:flex-end}
  .space{height:.7rem}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:.6rem}
  .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:.6rem}
  .grid-auto{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.6rem}
  .sticky-tools{position:sticky;top:52px;z-index:9;background:linear-gradient(180deg,var(--bg),rgba(15,17,21,.85));backdrop-filter:blur(6px);padding:.5rem;border-bottom:1px solid var(--outline)}
  .errorbar{position:fixed;left:0;right:0;bottom:0;z-index:100;background:rgba(239,68,68,.12);border-top:2px solid var(--red);padding:.6rem .9rem;color:#fecaca;font-size:.9rem}
  .errorbar code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  dialog{border:none;border-radius:.9rem;padding:0;max-width:min(900px,96vw)}
  .modal{background:var(--card);border:1px solid var(--outline);padding:1rem;border-radius:.9rem}
  dialog::backdrop{background:rgba(0,0,0,.5)}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:.8rem}
  @media (max-width:800px){.kpis{grid-template-columns:repeat(2,1fr)}}
  .kpi{background:#0e1117;border:1px solid var(--outline);border-radius:.8rem;padding:.8rem}
  .kpi .big{font-size:1.4rem;font-weight:700}
  .scroll-x{overflow-x:auto}
  .trash-badge{font-size:.75rem;color:#fca5a5}
</style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="brand">CENTER CAR • V3.5</div>
    <nav id="tabs"></nav>
    <div class="flex">
      <button class="btn" id="btnImport">Εισαγωγή</button>
      <button class="btn" id="btnExport">Εξαγωγή JSON</button>
      <button class="btn" id="btnPDF">Εξαγωγή PDF</button>
    </div>
  </div>
</header>

<div class="container">
  <div id="view"></div>
</div>

<div id="errorHost"></div>

<dialog id="modal">
  <div class="modal">
    <div class="flex right">
      <button class="btn" onclick="closeModal()">Κλείσιμο</button>
    </div>
    <div id="modalBody"></div>
  </div>
</dialog>

<script>
// -------- Utilities
const el = (html)=> {
  const t = document.createElement('template');
  t.innerHTML = html.trim();
  return t.content.firstElementChild;
};
const fmt = new Intl.NumberFormat('el-GR',{style:'currency',currency:'EUR',maximumFractionDigits:0});
const dfmt = (s)=> s? new Date(s).toLocaleDateString('el-GR'):'';
const uid = ()=> Math.random().toString(36).slice(2,10);
const sum = (arr)=> arr.reduce((a,b)=> a + (Number(b)||0), 0);
const clone = (o)=> JSON.parse(JSON.stringify(o));

// -------- Global Error Catcher
window.addEventListener('error', (e)=> showError(e.message, e.filename, e.lineno, e.colno, e.error?.stack));
window.addEventListener('unhandledrejection', (e)=> showError('Promise rejection: '+ e.reason, '', 0, 0, ''));
function showError(msg,file,line,col,stack){
  const host = document.getElementById('errorHost');
  const bar = el(`<div class="errorbar">
    <div><strong>Σφάλμα:</strong> ${msg.replace(/</g,'&lt;')}</div>
    <div class="muted"><code>${file||''}:${line||''}:${col||''}</code></div>
    ${stack? `<div><code>${String(stack).slice(0,500)}</code></div>`:''}
  </div>`);
  host.innerHTML=''; host.append(bar);
  console.error(msg, file, line, col, stack);
  setTimeout(()=> { if (host.contains(bar)) host.removeChild(bar); }, 8000);
}

// -------- Storage & Version
const VERSION = new URLSearchParams(location.search).get('v') || '35';
const KEY = 'ccar.v3.5.'+VERSION;
function load(){
  const raw = localStorage.getItem(KEY);
  const data = raw? JSON.parse(raw) : seed();
  return migrate(data);
}
function save(){
  localStorage.setItem(KEY, JSON.stringify(state));
}
function seed(){
  return {
    meta:{created:Date.now(), version:VERSION},
    settings:{ ownerName:'Άγγελος', personalMonthlyLimit:0, reportMode:'cash', partners:['Άγγελος'] },
    capitalLedger:[], // {id,date,type:'in'|'out', amount, dest:'personal'|'free', note}
    freeHistory:[],   // {id,date,kind:'ledger'|'commit'|'release'|'expense'|'receipt'|'manual', amount, note, ref}
    vehicles:[],      // see structure below
    expenses:[],      // {id,type:'overhead'|'vehicle', vehicleId:null|id, category, whoPaid, status:'unpaid'|'paid', amount, dueDate, note, date}
    sold:[],          // vehicle ids concluded (for fast view)
    oldDebts:{ cases:[], owedToMe:[] }, // cases: {id,title, name, capitalOwed, profitOwed, receipts:[]}
    trash:{ vehicles:[], expenses:[] }
  };
}
function migrate(data){
  // Fill missing arrays/fields to avoid JS errors
  data.settings ??= {ownerName:'', personalMonthlyLimit:0, reportMode:'cash', partners:['Άγγελος']};
  data.settings.partners ??= ['Άγγελος'];
  data.capitalLedger ??= [];
  data.freeHistory ??= [];
  data.vehicles ??= [];
  data.expenses ??= [];
  data.sold ??= [];
  data.oldDebts ??= {cases:[], owedToMe:[]};
  data.trash ??= {vehicles:[], expenses:[]};

  // Vehicles migration
  for(const v of data.vehicles){
    v.id ??= uid();
    v.title ??= 'Όχημα';
    v.vin ??= '';
    v.purchaseDate ??= '';
    v.purchasePrice = Number(v.purchasePrice||0);
    v.customerVehicle = Boolean(v.customerVehicle);
    v.partners ??= [{name: data.settings?.ownerName || 'Άγγελος', capital: v.purchasePrice||0}];
    v.sale ??= {price:0, date:'', settled:false, tradeIn:null};
    v.receipts ??= []; // {id,date,type:'capital'|'profit', amount, dest:'free'|'vehicle'|'split', details:{}, owner}
    v.commits ??= [];  // {id,date,kind:'commit'|'release', name, amount, note}
    v.notes ??= '';
    v.deleted ??= false;
    v.archived ??= false;
  }
  // Expenses migration
  for(const e of data.expenses){
    e.id ??= uid();
    e.type ??= e.vehicleId? 'vehicle':'overhead';
    e.status ??= e.status || 'unpaid';
    e.amount = Number(e.amount||0);
    e.whoPaid ??= '';
  }
  // Old Debts
  data.oldDebts.cases ??= [];
  data.oldDebts.owedToMe ??= [];
  return data;
}

let state = load();

// -------- Calculations
function getOwner(){ return state.settings.ownerName || 'Άγγελος'; }

function vehicleTotals(v){
  const partnerCapital = Object.fromEntries(v.partners.map(p=>[p.name, Number(p.capital||0)]));
  const yourName = getOwner();
  const yourCapital = Number(partnerCapital[yourName]||0);

  const vExp = state.expenses.filter(e=> e.type==='vehicle' && e.vehicleId===v.id);
  const expensesByWho = {};
  for(const e of vExp){ expensesByWho[e.whoPaid] = (expensesByWho[e.whoPaid]||0) + Number(e.amount||0); }
  const yourExpenses = Number(expensesByWho[yourName]||0);
  const totalExpenses = sum(vExp.map(x=>x.amount));

  const receipts = v.receipts || [];
  const yourCapitalReceipts = sum(receipts.filter(r=> r.type==='capital' && r.owner===yourName).map(r=> Number(r.amount||0)));
  const yourProfitReceipts  = sum(receipts.filter(r=> r.type==='profit'  && r.owner===yourName).map(r=> Number(r.amount||0)));

  const price = Number(v.sale?.price||0);
  const grossProfit = Math.max(0, price - v.purchasePrice - totalExpenses);

  const yourCapitalBalance = Math.max(0, (yourCapital + yourExpenses) - yourCapitalReceipts);
  const alone = v.partners.length===1 && v.partners[0].name===yourName;
  const yourProfitShare = alone ? grossProfit : grossProfit/2;
  const yourProfitBalance = Math.max(0, yourProfitShare - yourProfitReceipts);

  const committed = sum(v.commits.filter(c=> c.kind==='commit').map(c=> Number(c.amount||0))) - sum(v.commits.filter(c=> c.kind==='release').map(c=> Number(c.amount||0)));
  return {
    partnerCapital, yourCapital, yourExpenses, totalExpenses, price, grossProfit,
    yourCapitalReceipts, yourProfitReceipts, yourCapitalBalance, yourProfitBalance, committed
  };
}

function computeFree(){
  const yourName = getOwner();
  let free = 0;

  // Ledger → Free
  for(const m of state.capitalLedger){
    if(m.dest==='free') free += (m.type==='in'? Number(m.amount): -Number(m.amount||0));
  }

  // Vehicles: commits/releases, paid expenses by you, receipts to Free/Split
  for(const v of state.vehicles){
    for(const c of v.commits){
      if(c.name===yourName){
        free += (c.kind==='commit'? -Number(c.amount||0): Number(c.amount||0));
      }
    }
    const paidByYou = state.expenses.filter(e=> e.type==='vehicle' && e.vehicleId===v.id && e.status==='paid' && e.whoPaid===yourName);
    free -= sum(paidByYou.map(x=> x.amount));
    for(const r of v.receipts){
      if(r.owner===yourName && r.dest==='free') free += Number(r.amount||0);
      if(r.owner===yourName && r.dest==='split' && r.details?.toFree) free += Number(r.details.toFree||0);
    }
  }

  // Overheads you paid
  const ohPaid = state.expenses.filter(e=> e.type==='overhead' && e.status==='paid' && e.whoPaid===yourName);
  free -= sum(ohPaid.map(x=> x.amount));

  // Old Debts → only part to Free
  for(const c of state.oldDebts.cases){
    for(const r of (c.receipts||[])){
      if(r.owner===yourName){
        if(r.dest==='free') free += Number(r.amount||0);
        else if(r.dest==='split' && r.details?.toFree) free += Number(r.details.toFree||0);
      }
    }
  }

  return free;
}

// -------- UI Tabs
const TABS = [
  {id:'dash', title:'Πίνακας Ελέγχου'},
  {id:'vehicles', title:'Οχήματα'},
  {id:'expenses', title:'Έξοδα'},
  {id:'capital', title:'Κεφάλαιο'},
  {id:'sold', title:'Πωλημένα'},
  {id:'settings', title:'Ρυθμίσεις'},
  {id:'olddebts', title:'Παλιές Οφειλές'},
  {id:'trash', title:'Διεγραμμένα'}
];
let currentTab = 'dash';

function renderTabs(){
  const nav = document.getElementById('tabs');
  nav.innerHTML='';
  for(const t of TABS){
    const b = el(`<button class="btn ${t.id===currentTab?'active':''}">${t.title}</button>`);
    b.onclick = ()=> { currentTab = t.id; draw(); };
    nav.append(b);
  }
}
function draw(){ renderTabs(); const v = document.getElementById('view'); v.innerHTML='';
  try {
    if(currentTab==='dash') return viewDashboard(v);
    if(currentTab==='vehicles') return viewVehicles(v);
    if(currentTab==='expenses') return viewExpenses(v);
    if(currentTab==='capital') return viewCapital(v);
    if(currentTab==='sold') return viewSold(v);
    if(currentTab==='settings') return viewSettings(v);
    if(currentTab==='olddebts') return viewOldDebts(v);
    if(currentTab==='trash') return viewTrash(v);
  } catch(e){ showError(e.message, '', 0,0, e.stack); }
}

// -------- Dashboard
function viewDashboard(host){
  const free = computeFree();
  const totalInvested = sum(state.vehicles.map(v=> v.purchasePrice));
  const totalGrossProfit = sum(state.vehicles.map(v=> vehicleTotals(v).grossProfit));
  const expectedYourProfit = sum(state.vehicles.map(v=> vehicleTotals(v).yourProfitBalance));
  host.append(el(`<div class="kpis">
    <div class="kpi"><div class="muted">Free Capital</div><div class="big">${fmt.format(free)}</div>
      <div><button class="btn" onclick="openFreeHistory()">ℹ Ιστορικό Free</button></div></div>
    <div class="kpi"><div class="muted">Συνολικές Αγορές</div><div class="big">${fmt.format(totalInvested)}</div></div>
    <div class="kpi"><div class="muted">Μικτό Κέρδος (όλων)</div><div class="big">${fmt.format(totalGrossProfit)}</div></div>
    <div class="kpi"><div class="muted">Αναμενόμενο Κέρδος (Δικό σου)</div><div class="big">${fmt.format(expectedYourProfit)}</div></div>
  </div>`));
}

function openFreeHistory(){
  const free = computeFree();
  const items = state.freeHistory;
  const body = [`<h3>Ιστορικό Free (τρέχον: ${fmt.format(free)})</h3>`,
  `<div class="scroll-x"><table><thead><tr>
    <th>Ημ/νία</th><th>Είδος</th><th>Σημείωση</th><th>Ποσό</th><th></th></tr></thead><tbody>`];
  for(const it of items){
    body.push(`<tr><td>${dfmt(it.date)}</td><td>${it.kind}</td><td>${it.note||''}</td>
    <td>${fmt.format(Number(it.amount||0))}</td><td><button class="btn danger" onclick="delFreeHist('${it.id}')">Διαγραφή</button></td></tr>`);
  }
  body.push(`</tbody></table></div>`);
  openModal(body.join(''));
}
function delFreeHist(id){
  state.freeHistory = state.freeHistory.filter(x=> x.id!==id);
  save(); closeModal(); openFreeHistory();
}

// -------- Settings
function viewSettings(host){
  const s = state.settings;
  const partnersList = s.partners.join(', ');
  host.append(el(`<div class="card">
    <h3>Ρυθμίσεις</h3>
    <div class="grid-3">
      <div><label>Όνομα ιδιοκτήτη</label><input id="ownerName" value="${s.ownerName||''}"></div>
      <div><label>Μηνιαίο όριο Προσωπικών</label><input type="number" id="limit" value="${s.personalMonthlyLimit||0}"></div>
      <div><label>Λειτουργία αναφορών</label>
        <select id="reportMode">
          <option value="cash" ${s.reportMode==='cash'?'selected':''}>Cash</option>
          <option value="accrual" ${s.reportMode==='accrual'?'selected':''}>Accrual (placeholder)</option>
        </select></div>
    </div>
    <div class="space"></div>
    <label>Συνεργάτες (λίστα)</label>
    <div class="flex">
      <input id="partners" value="${partnersList}" placeholder="Χώρισε με κόμμα (,)">
      <button class="btn primary" onclick="saveSettings()">Αποθήκευση</button>
    </div>
  </div>`));
}
function saveSettings(){
  const ownerName = document.getElementById('ownerName').value.trim()||'Άγγελος';
  const limit = Number(document.getElementById('limit').value||0);
  const reportMode = document.getElementById('reportMode').value;
  const partners = document.getElementById('partners').value.split(',').map(x=>x.trim()).filter(Boolean);
  state.settings = {ownerName, personalMonthlyLimit:limit, reportMode, partners: Array.from(new Set(partners))};
  save(); draw();
}

// -------- Capital (Personal + Free)
function viewCapital(host){
  const ledger = state.capitalLedger;
  const free = computeFree();
  host.append(el(`<div class="row">
    <div class="card">
      <h3>+ Κίνηση Προσωπικού Κεφαλαίου</h3>
      <div class="grid-3">
        <div><label>Τύπος</label><select id="cap_type"><option value="in">Κατάθεση</option><option value="out">Ανάληψη</option></select></div>
        <div><label>Προορισμός</label><select id="cap_dest"><option value="personal">Προσωπικό</option><option value="free">Ελεύθερο (Free)</option></select></div>
        <div><label>Ποσό</label><input id="cap_amount" type="number" step="0.01"></div>
      </div>
      <div class="grid-3">
        <div><label>Ημ/νία</label><input id="cap_date" type="date"></div>
        <div class="grid-2"><div><label>Σημείωση</label><input id="cap_note"></div>
        <div style="align-self:end"><button class="btn primary" onclick="addCap()">Καταχώριση</button></div></div>
      </div>
      <div class="space"></div>
      <div class="muted">Το Free ενημερώνεται αυτόματα όταν ο προορισμός είναι Free και γράφεται στο Ιστορικό Free.</div>
    </div>
    <div class="card">
      <h3>Ισοζύγιο</h3>
      <div>Free Capital: <strong>${fmt.format(free)}</strong> <button class="btn" onclick="openFreeHistory()">ℹ</button></div>
      <div class="space"></div>
      <h3>Ledger</h3>
      <div class="scroll-x"><table><thead><tr><th>Ημ/νία</th><th>Τύπος</th><th>Προορισμός</th><th>Ποσό</th><th>Σημείωση</th><th></th></tr></thead><tbody id="cap_rows"></tbody></table></div>
    </div>
  </div>`));
  const tbody = document.getElementById('cap_rows');
  for(const m of ledger){
    tbody.append(el(`<tr>
      <td>${dfmt(m.date)}</td><td>${m.type}</td><td>${m.dest}</td><td>${fmt.format(m.amount)}</td><td>${m.note||''}</td>
      <td><button class="btn danger" onclick="delCap('${m.id}')">Διαγραφή</button></td></tr>`));
  }
}
function addCap(){
  const type = document.getElementById('cap_type').value;
  const dest = document.getElementById('cap_dest').value;
  const amount = Number(document.getElementById('cap_amount').value||0);
  const date = document.getElementById('cap_date').value || new Date().toISOString().slice(0,10);
  const note = document.getElementById('cap_note').value;
  const m = {id:uid(), type, dest, amount, date, note};
  state.capitalLedger.unshift(m);
  if(dest==='free'){
    state.freeHistory.unshift({id:uid(), date, kind:'ledger', amount: (type==='in'? amount: -amount), note, ref:m.id});
  }
  save(); draw();
}
function delCap(id){
  const m = state.capitalLedger.find(x=> x.id===id);
  state.capitalLedger = state.capitalLedger.filter(x=> x.id!==id);
  if(m?.dest==='free'){
    state.freeHistory = state.freeHistory.filter(x=> x.ref!==id);
  }
  save(); draw();
}

// -------- Vehicles (list + add/edit/delete shells)
function viewVehicles(host){
  const tools = el(`<div class="sticky-tools flex">
    <button class="btn primary" onclick="openAddVehicle()">+ Προσθήκη Οχήματος</button>
  </div>`);
  host.append(tools);
  const table = el(`<div class="card scroll-x">
    <table><thead><tr>
      <th>Τίτλος</th><th>VIN</th><th>Αγορά</th><th>Συνεργάτες(κεφάλαιο)</th>
      <th>Δεσμευμένο</th><th>Έξοδα</th><th>Υπ. Κεφαλαίου (ΔΙΚΟ σου)</th><th>Υπ. Κέρδους (ΔΙΚΟ σου)</th><th>Πώληση</th><th>Δράσεις</th>
    </tr></thead><tbody id="veh_rows"></tbody></table></div>`);
  host.append(table);
  const tbody = document.getElementById('veh_rows');
  for(const v of state.vehicles.filter(v=> !v.deleted && !v.archived)){
    const totals = vehicleTotals(v);
    const partnersStr = v.partners.map(p=> `${p.name} (${fmt.format(p.capital)})`).join(', ');
    const actions = el(`<div class="flex">
      <button class="btn" onclick="openVehicleExpenses('${v.id}')">Έξοδα</button>
      <button class="btn" onclick="openPartners('${v.id}')">Συνεργάτες</button>
      <button class="btn" onclick="openSale('${v.id}')">Πώληση</button>
      <button class="btn" onclick="openReceipt('${v.id}')">Είσπραξη</button>
      <button class="btn" onclick="openVehHistory('${v.id}')">Ιστορικό</button>
      <button class="btn warn" onclick="openEditVehicle('${v.id}')">Επεξεργασία</button>
      <button class="btn danger" onclick="openDeleteVehicle('${v.id}')">Διαγραφή</button>
    </div>`);
    const tr = el(`<tr>
      <td>${v.title}</td><td>${v.vin||''}</td>
      <td>${dfmt(v.purchaseDate)}<div class="muted">${fmt.format(v.purchasePrice)}</div></td>
      <td>${partnersStr}</td>
      <td>${fmt.format(totals.committed)}</td>
      <td>${fmt.format(totals.totalExpenses)}</td>
      <td>${fmt.format(totals.yourCapitalBalance)}</td>
      <td>${fmt.format(totals.yourProfitBalance)}</td>
      <td>${v.sale?.price? fmt.format(v.sale.price):'-'}</td>
      <td></td>
    </tr>`);
    tr.lastElementChild.append(actions);
    tbody.append(tr);
  }
}

function openAddVehicle(){
  // initialize temp partners OUTSIDE of HTML
  window._tmpParts = [{ name: getOwner(), capital: 0 }];

  openModal(`<h3>Προσθήκη Οχήματος</h3>
    <div class="grid-2">
      <div><label>Τίτλος/Μοντέλο</label><input id="v_title"></div>
      <div><label>VIN</label><input id="v_vin"></div>
    </div>
    <div class="grid-3">
      <div><label>Ημ/νία αγοράς</label><input type="date" id="v_date"></div>
      <div><label>Τιμή αγοράς</label><input type="number" id="v_price"></div>
      <div class="flex" style="align-items:end">
        <label class="flex"><input type="checkbox" id="v_customer"> &nbsp;Όχημα πελάτη</label>
      </div>
    </div>
    <div class="space"></div>
    <h4>Συνεργάτες & κεφάλαιο</h4>
    <div id="v_parts"></div>
    <div class="space"></div>
    <div class="flex right">
      <button class="btn" onclick="addPartnerRow()">+ Συνεργάτης</button>
      <button class="btn primary" onclick="saveNewVehicle()">Αποθήκευση</button>
    </div>
  `);
  renderPartnerRows();
}
function addPartnerRow(){ window._tmpParts.push({name:getOwner(), capital:0}); renderPartnerRows(); }
function renderPartnerRows(){
  const box = document.getElementById('v_parts'); if(!box) return;
  const names = state.settings.partners;
  box.innerHTML='';
  window._tmpParts.forEach((p,i)=>{
    const row = el(`<div class="grid-3" style="margin:.4rem 0">
      <div><select data-i="${i}" class="selName">${names.map(n=> `<option ${n===p.name?'selected':''}>${n}</option>`).join('')}</select></div>
      <div><input type="number" class="inpCap" data-i="${i}" value="${p.capital||0}" placeholder="Κεφάλαιο"></div>
      <div><button class="btn danger" onclick="removePartRow(${i})">Αφαίρεση</button></div>
    </div>`);
    box.append(row);
  });
  box.querySelectorAll('.selName').forEach(sel=> sel.onchange = (e)=>{
    const i = Number(e.target.dataset.i); window._tmpParts[i].name = e.target.value; });
  box.querySelectorAll('.inpCap').forEach(inp=> inp.oninput = (e)=>{
    const i = Number(e.target.dataset.i); window._tmpParts[i].capital = Number(e.target.value||0); });
}
function removePartRow(i){ window._tmpParts.splice(i,1); renderPartnerRows(); }
function saveNewVehicle(){
  const v = {
    id:uid(),
    title: document.getElementById('v_title').value || 'Όχημα',
    vin: document.getElementById('v_vin').value || '',
    purchaseDate: document.getElementById('v_date').value || '',
    purchasePrice: Number(document.getElementById('v_price').value||0),
    customerVehicle: document.getElementById('v_customer').checked,
    partners: (window._tmpParts||[]).map(p=>({name:p.name, capital:Number(p.capital||0)})),
    sale:{price:0,date:'',settled:false,tradeIn:null},
    commits:[], receipts:[], notes:'', archived:false, deleted:false
  };
  state.vehicles.unshift(v); save(); closeModal(); draw();
}

function openEditVehicle(id){
  const v = state.vehicles.find(x=> x.id===id); if(!v) return;
  window._editParts = clone(v.partners);
  openModal(`<h3>Επεξεργασία Οχήματος</h3>
    <div class="grid-2">
      <div><label>Τίτλος/Μοντέλο</label><input id="e_title" value="${v.title}"></div>
      <div><label>VIN</label><input id="e_vin" value="${v.vin}"></div>
    </div>
    <div class="grid-3">
      <div><label>Ημ/νία αγοράς</label><input type="date" id="e_date" value="${v.purchaseDate||''}"></div>
      <div><label>Τιμή αγοράς</label><input type="number" id="e_price" value="${v.purchasePrice}"></div>
      <div class="flex" style="align-items:end">
        <label class="flex"><input type="checkbox" id="e_customer" ${v.customerVehicle?'checked':''}> &nbsp;Όχημα πελάτη</label>
      </div>
    </div>
    <div class="space"></div>
    <h4>Συνεργάτες & κεφάλαια</h4>
    <div id="e_parts"></div>
    <div class="flex right"><button class="btn" onclick="addEditPartRow()">+ Συνεργάτης</button></div>
    <div class="space"></div>
    <div class="flex right">
      <button class="btn primary" onclick="saveEditVehicle('${v.id}')">Αποθήκευση</button>
    </div>`);
  renderEditPartRows();
}
function renderEditPartRows(){
  const box = document.getElementById('e_parts'); if(!box) return;
  const names = state.settings.partners;
  box.innerHTML='';
  window._editParts.forEach((p,i)=>{
    const row = el(`<div class="grid-3" style="margin:.4rem 0">
      <div><select data-i="${i}" class="selName">${names.map(n=> `<option ${n===p.name?'selected':''}>${n}</option>`).join('')}</select></div>
      <div><input type="number" class="inpCap" data-i="${i}" value="${p.capital||0}" placeholder="Κεφάλαιο"></div>
      <div><button class="btn danger" onclick="removeEditPartRow(${i})">Αφαίρεση</button></div>
    </div>`);
    box.append(row);
  });
  box.querySelectorAll('.selName').forEach(sel=> sel.onchange = (e)=>{
    const i = Number(e.target.dataset.i); window._editParts[i].name = e.target.value; });
  box.querySelectorAll('.inpCap').forEach(inp=> inp.oninput = (e)=>{
    const i = Number(e.target.dataset.i); window._editParts[i].capital = Number(e.target.value||0); });
}
function addEditPartRow(){ window._editParts.push({name:getOwner(), capital:0}); renderEditPartRows(); }
function removeEditPartRow(i){ window._editParts.splice(i,1); renderEditPartRows(); }
function saveEditVehicle(id){
  const v = state.vehicles.find(x=> x.id===id); if(!v) return;
  v.title = document.getElementById('e_title').value || v.title;
  v.vin = document.getElementById('e_vin').value || '';
  v.purchaseDate = document.getElementById('e_date').value || '';
  v.purchasePrice = Number(document.getElementById('e_price').value||0);
  v.customerVehicle = document.getElementById('e_customer').checked;
  v.partners = window._editParts;
  save(); closeModal(); draw();
}

function openDeleteVehicle(id){
  openModal(`<h3>Διαγραφή Οχήματος</h3>
    <p>Διάλεξε τρόπο διαγραφής. Η <strong>RETURN</strong> επιστρέφει τα δεσμευμένα του ιδιοκτήτη στο Free. Η <strong>WIPE</strong> δεν επιστρέφει τίποτα.</p>
    <div class="flex right">
      <button class="btn warn" onclick="deleteVehicle('${id}','RETURN')">RETURN</button>
      <button class="btn danger" onclick="deleteVehicle('${id}','WIPE')">WIPE</button>
    </div>`);
}
function deleteVehicle(id,mode){
  const idx = state.vehicles.findIndex(x=> x.id===id); if(idx<0) return;
  const v = state.vehicles[idx];
  state.trash.vehicles.unshift(clone(v));
  if(mode==='RETURN'){
    const yourName = getOwner();
    const committed = v.commits.filter(c=> c.kind==='commit' && c.name===yourName)
      .reduce((a,c)=> a+Number(c.amount||0), 0);
    const released = v.commits.filter(c=> c.kind==='release' && c.name===yourName)
      .reduce((a,c)=> a+Number(c.amount||0), 0);
    const toReturn = Math.max(0, committed - released);
    if(toReturn>0){
      state.freeHistory.unshift({id:uid(), date:new Date().toISOString().slice(0,10), kind:'release', amount: toReturn, note:`RETURN από διαγραφή οχήματος ${v.title}`, ref:v.id});
    }
  }
  state.vehicles.splice(idx,1);
  save(); closeModal(); draw();
}

function openVehicleExpenses(id){
  const v = state.vehicles.find(x=> x.id===id); if(!v) return;
  const exps = state.expenses.filter(e=> e.type==='vehicle' && e.vehicleId===id);
  const body = [`<h3>Έξοδα Οχήματος — ${v.title}</h3>
  <div class="grid-auto">
    <div><label>Ποσό</label><input id="ve_amount" type="number"></div>
    <div><label>Ποιος πλήρωσε</label><select id="ve_who">${state.settings.partners.map(n=> `<option>${n}</option>`)}</select></div>
    <div><label>Κατάσταση</label><select id="ve_status"><option value="unpaid">Unpaid</option><option value="paid">Paid</option></select></div>
    <div><label>Σημείωση</label><input id="ve_note"></div>
    <div><label>Ημ/νία</label><input id="ve_date" type="date"></div>
    <div style="align-self:end"><button class="btn primary" onclick="addVehExpense('${id}')">+ Προσθήκη</button></div>
  </div>
  <div class="space"></div>
  <div class="scroll-x"><table><thead><tr><th>Ημ/νία</th><th>Ποσό</th><th>Ποιος</th><th>Κατάσταση</th><th>Σημείωση</th><th></th></tr></thead><tbody>`];
  for(const e of exps){
    body.push(`<tr><td>${dfmt(e.date)}</td><td>${fmt.format(e.amount)}</td><td>${e.whoPaid}</td><td>${e.status}</td><td>${e.note||''}</td>
    <td><button class="btn danger" onclick="delExpense('${e.id}')">Διαγραφή</button></td></tr>`);
  }
  body.push(`</tbody></table></div>`);
  openModal(body.join(''));
}
function addVehExpense(id){
  const amount = Number(document.getElementById('ve_amount').value||0);
  const whoPaid = document.getElementById('ve_who').value;
  const status = document.getElementById('ve_status').value;
  const note = document.getElementById('ve_note').value;
  const date = document.getElementById('ve_date').value || new Date().toISOString().slice(0,10);
  const e = {id:uid(), type:'vehicle', vehicleId:id, amount, whoPaid, status, note, date};
  state.expenses.unshift(e);
  if(status==='paid' && whoPaid===getOwner()){
    state.freeHistory.unshift({id:uid(), date, kind:'expense', amount:-amount, note:`Έξοδο οχήματος (${note||'χωρίς'})`, ref:e.id});
  }
  save(); closeModal(); openVehicleExpenses(id);
}
function delExpense(id){
  const e = state.expenses.find(x=> x.id===id);
  state.expenses = state.expenses.filter(x=> x.id!==id);
  if(e?.type==='vehicle') state.trash.expenses.unshift(e);
  if(e?.status==='paid' && e?.whoPaid===getOwner()){
    state.freeHistory = state.freeHistory.filter(x=> x.ref!==id);
  }
  save(); draw(); if(e?.vehicleId) { closeModal(); openVehicleExpenses(e.vehicleId); }
}

function openPartners(id){
  const v = state.vehicles.find(x=> x.id===id); if(!v) return;
  openModal(`<h3>Συνεργάτες — ${v.title}</h3>
    <div id="p_rows"></div>
    <div class="space"></div>
    <div class="grid-3">
      <div><label>Δέσμευση/Αποδέσμευση</label>
        <select id="pc_kind"><option value="commit">Δέσμευση</option><option value="release">Αποδέσμευση</option></select></div>
      <div><label>Όνομα</label><select id="pc_name">${state.settings.partners.map(n=> `<option>${n}</option>`)}</select></div>
      <div><label>Ποσό</label><input id="pc_amount" type="number"></div>
    </div>
    <div class="grid-3">
      <div><label>Ημ/νία</label><input id="pc_date" type="date"></div>
      <div><label>Σημείωση</label><input id="pc_note"></div>
      <div style="align-self:end"><button class="btn primary" onclick="addCommit('${id}')">Καταχώριση</button></div>
    </div>`);
  const box = document.getElementById('p_rows');
  const rows = [`<div class="scroll-x"><table><thead><tr><th>Συνεργάτης</th><th>Κεφάλαιο</th></tr></thead><tbody>`];
  for(const p of v.partners){ rows.push(`<tr><td>${p.name}</td><td>${fmt.format(p.capital)}</td></tr>`); }
  rows.push(`</tbody></table></div>`);
  const commits = [`<h4>Κινήσεις Κεφαλαίου</h4><div class="scroll-x"><table><thead><tr><th>Ημ/νία</th><th>Είδος</th><th>Όνομα</th><th>Ποσό</th><th>Σημείωση</th></tr></thead><tbody>`];
  for(const c of v.commits){ commits.push(`<tr><td>${dfmt(c.date)}</td><td>${c.kind}</td><td>${c.name}</td><td>${fmt.format(c.amount)}</td><td>${c.note||''}</td></tr>`); }
  commits.push(`</tbody></table></div>`);
  box.innerHTML = rows.join('') + commits.join('');
}
function addCommit(id){
  const v = state.vehicles.find(x=> x.id===id); if(!v) return;
  const kind = document.getElementById('pc_kind').value;
  const name = document.getElementById('pc_name').value;
  const amount = Number(document.getElementById('pc_amount').value||0);
  const date = document.getElementById('pc_date').value || new Date().toISOString().slice(0,10);
  const note = document.getElementById('pc_note').value;
  v.commits.unshift({id:uid(), kind, name, amount, date, note});
  if(name===getOwner()){
    state.freeHistory.unshift({id:uid(), date, kind, amount: (kind==='commit'? -amount: amount), note:`${kind} ${v.title}`, ref:v.id});
  }
  save(); closeModal(); openPartners(id);
}

function openSale(id){
  const v = state.vehicles.find(x=> x.id===id); if(!v) return;
  openModal(`<h3>Πώληση — ${v.title}</h3>
    <div class="grid-3">
      <div><label>Τιμή πώλησης</label><input id="s_price" type="number" value="${v.sale?.price||0}"></div>
      <div><label>Ημ/νία</label><input id="s_date" type="date" value="${v.sale?.date||''}"></div>
      <div><label>Ολοκληρωμένη;</label><select id="s_settled"><option value="false" ${!v.sale?.settled?'selected':''}>Όχι</option><option value="true" ${v.sale?.settled?'selected':''}>Ναι</option></select></div>
    </div>
    <div class="space"></div>
    <details><summary>Trade-in (προαιρετικό)</summary>
      <div class="grid-3">
        <div><label>Τίτλος</label><input id="t_title" value="${v.sale?.tradeIn?.title||''}"></div>
        <div><label>VIN</label><input id="t_vin" value="${v.sale?.tradeIn?.vin||''}"></div>
        <div><label>Ημ/νία</label><input id="t_date" type="date" value="${v.sale?.tradeIn?.date||''}"></div>
      </div>
      <div class="grid-3">
        <div><label>Πηγή κεφαλαίου</label><select id="t_source"><option value="capital">Capital</option><option value="profit">Profit</option></select></div>
        <div><label>Συγχρηματοδότες (comma)</label><input id="t_partners" placeholder="π.χ. Άγγελος, Χρήστος"></div>
        <div><label>Σημείωση</label><input id="t_note"></div>
      </div>
    </details>
    <div class="flex right"><button class="btn primary" onclick="saveSale('${id}')">Αποθήκευση</button></div>`);
}
function saveSale(id){
  const v = state.vehicles.find(x=> x.id===id); if(!v) return;
  const price = Number(document.getElementById('s_price').value||0);
  const date = document.getElementById('s_date').value || '';
  const settled = document.getElementById('s_settled').value==='true';
  const t_title = document.getElementById('t_title')?.value?.trim();
  if(t_title){
    v.sale.tradeIn = {
      title: t_title,
      vin: document.getElementById('t_vin').value.trim(),
      date: document.getElementById('t_date').value || '',
      source: document.getElementById('t_source').value,
      co: (document.getElementById('t_partners').value||'').split(',').map(x=>x.trim()).filter(Boolean),
      note: document.getElementById('t_note').value||''
    };
    const newV = {
      id:uid(), title: v.sale.tradeIn.title, vin: v.sale.tradeIn.vin, purchaseDate: v.sale.tradeIn.date,
      purchasePrice: 0, customerVehicle:false,
      partners: v.sale.tradeIn.co.map(n=> ({name:n, capital:0})),
      sale:{price:0,date:'',settled:false,tradeIn:null},
      commits:[], receipts:[], notes: v.sale.tradeIn.note, archived:false, deleted:false
    };
    state.vehicles.unshift(newV);
  }
  v.sale.price = price; v.sale.date = date; v.sale.settled = settled;
  save(); closeModal(); draw();
}

function openReceipt(id){
  const v = state.vehicles.find(x=> x.id===id); if(!v) return;
  const totals = vehicleTotals(v);
  openModal(`<h3>Είσπραξη — ${v.title}</h3>
    <div class="grid-3">
      <div><label>Τύπος</label><select id="r_type"><option value="capital">Capital</option><option value="profit">Profit</option></select></div>
      <div><label>Ποσό</label><input id="r_amount" type="number"></div>
      <div><label>Ημ/νία</label><input id="r_date" type="date"></div>
    </div>
    <div class="grid-3">
      <div><label>Προορισμός</label><select id="r_dest">
        <option value="free">Free</option>
        <option value="vehicle">Άλλο όχημα (Δέσμευση)</option>
        <option value="split">Split</option></select></div>
      <div><label>Σημείωση</label><input id="r_note"></div>
      <div></div>
    </div>
    <details><summary>Split επιλογές</summary>
      <div class="grid-3">
        <div><label>Προς Όχημα (id)</label><input id="r_toVeh"></div>
        <div><label>Ποσό προς Όχημα</label><input id="r_toVehAmt" type="number"></div>
        <div><label>Υπόλοιπο → Free</label><input id="r_toFree" type="number"></div>
      </div>
      <div class="grid-3">
        <div><label>→ Έξοδο (προσωπικό/σπίτι/μαγαζί/άλλο)</label><input id="r_toExp"></div>
        <div><label>→ Τσέπη</label><input id="r_toPocket" type="number"></div>
        <div></div>
      </div>
    </details>
    <div class="space"></div>
    <div class="card">
      <div>Υπόλοιπο κεφαλαίου — ΔΙΚΟ ΣΟΥ: <strong>${fmt.format(totals.yourCapitalBalance)}</strong></div>
      <div>Υπόλοιπο κέρδους — ΔΙΚΟ ΣΟΥ: <strong>${fmt.format(totals.yourProfitBalance)}</strong></div>
    </div>
    <div class="flex right"><button class="btn primary" onclick="saveReceipt('${id}')">Καταχώριση</button></div>`);
}
function saveReceipt(id){
  const v = state.vehicles.find(x=> x.id===id); if(!v) return;
  const type = document.getElementById('r_type').value;
  const amount = Number(document.getElementById('r_amount').value||0);
  const date = document.getElementById('r_date').value || new Date().toISOString().slice(0,10);
  const dest = document.getElementById('r_dest').value;
  const note = document.getElementById('r_note').value;
  const owner = getOwner();
  const totals = vehicleTotals(v);
  if(type==='capital' && amount>totals.yourCapitalBalance) return alert('Υπέρβαση υπολοίπου κεφαλαίου');
  if(type==='profit' && amount>totals.yourProfitBalance) return alert('Υπέρβαση υπολοίπου κέρδους');

  const rec = {id:uid(), date, type, amount, dest, details:{}, owner, note};
  if(dest==='vehicle'){
    const toVehId = prompt('Δώσε id οχήματος προορισμού (δες το στο Ιστορικό ή επεξεργασία):','');
    if(!toVehId) return;
    rec.details.toVehicle = toVehId;
  }
  if(dest==='split'){
    rec.details.toVehicle = document.getElementById('r_toVeh').value||null;
    rec.details.toVehicleAmt = Number(document.getElementById('r_toVehAmt').value||0);
    rec.details.toFree = Number(document.getElementById('r_toFree').value||0);
    rec.details.toExpense = document.getElementById('r_toExp').value||'';
    rec.details.toPocket = Number(document.getElementById('r_toPocket').value||0);
    const check = rec.details.toVehicleAmt + rec.details.toFree + rec.details.toPocket;
    if(Math.abs(check - amount)>0.01) return alert('Το split δεν ισούται με το ποσό');
  }
  v.receipts.unshift(rec);
  if(dest==='free'){
    state.freeHistory.unshift({id:uid(), date, kind:'receipt', amount, note:`Είσπραξη από ${v.title}`, ref:rec.id});
  } else if(dest==='split'){
    const f = Number(rec.details.toFree||0);
    if(f>0) state.freeHistory.unshift({id:uid(), date, kind:'receipt', amount:f, note:`Split Free από ${v.title}`, ref:rec.id});
  }
  if(dest==='vehicle' || (dest==='split' && rec.details.toVehicle && rec.details.toVehicleAmt>0)){
    const toId = rec.details.toVehicle;
    const amt = dest==='vehicle'? amount : rec.details.toVehicleAmt;
    const toV = state.vehicles.find(x=> x.id===toId);
    if(toV){
      toV.commits.unshift({id:uid(), kind:'commit', name:getOwner(), amount:amt, date, note:`Από είσπραξη ${v.title}`});
      state.freeHistory.unshift({id:uid(), date, kind:'commit', amount:-amt, note:`Δέσμευση προς ${toV.title} από είσπραξη ${v.title}`, ref:toV.id});
    }
  }
  save(); closeModal(); draw();
}

function openVehHistory(id){
  const v = state.vehicles.find(x=> x.id===id); if(!v) return;
  const t = vehicleTotals(v);
  const body = [`<h3>Ιστορικό — ${v.title}</h3>`,
  `<div class="grid-2">
    <div class="card"><div class="muted">Αρχικό κεφάλαιο προς επιστροφή (όλων)</div><div class="big">${fmt.format(v.purchasePrice)}</div></div>
    <div class="card"><div class="muted">Μικτό κέρδος</div><div class="big">${fmt.format(t.grossProfit)}</div></div>
  </div>`,
  `<h4>Σύνολα Εισπράξεων (ΔΙΚΑ σου)</h4>
   <div class="grid-2">
     <div class="card">Capital: <strong>${fmt.format(t.yourCapitalReceipts)}</strong></div>
     <div class="card">Profit: <strong>${fmt.format(t.yourProfitReceipts)}</strong></div>
   </div>`,
   `<h4>Κινήσεις</h4>
    <div class="scroll-x"><table><thead><tr><th>Ημ/νία</th><th>Τύπος</th><th>Στοιχεία</th><th>Ποσό</th></tr></thead><tbody>`];
  for(const c of v.commits){ body.push(`<tr><td>${dfmt(c.date)}</td><td>${c.kind}</td><td>${c.name} — ${c.note||''}</td><td>${fmt.format(c.amount)}</td></tr>`); }
  for(const r of v.receipts){ body.push(`<tr><td>${dfmt(r.date)}</td><td>receipt ${r.type}</td><td>${r.dest} — ${r.note||''}</td><td>${fmt.format(r.amount)}</td></tr>`); }
  body.push(`</tbody></table></div>`);
  openModal(body.join(''));
}

// -------- Expenses
function viewExpenses(host){
  host.append(el(`<div class="row">
    <div class="card">
      <h3>+ Γενικό έξοδο (Overhead)</h3>
      <div class="grid-3">
        <div><label>Κατηγορία</label><input id="oh_cat"></div>
        <div><label>Ποιος</label><select id="oh_who">${state.settings.partners.map(n=> `<option>${n}</option>`)}</select></div>
        <div><label>Κατάσταση</label><select id="oh_status"><option value="unpaid">Unpaid</option><option value="paid">Paid</option></select></div>
      </div>
      <div class="grid-3">
        <div><label>Ποσό</label><input id="oh_amount" type="number"></div>
        <div><label>Ημ/νία</label><input id="oh_date" type="date"></div>
        <div><label>Σημείωση</label><input id="oh_note"></div>
      </div>
      <div class="flex right"><button class="btn primary" onclick="addOverhead()">Προσθήκη</button></div>
    </div>
    <div class="card">
      <h3>Λίστες</h3>
      <details open><summary>Overheads</summary>
        <div class="scroll-x"><table><thead><tr><th>Ημ/νία</th><th>Κατηγορία</th><th>Ποιος</th><th>Κατάσταση</th><th>Ποσό</th><th>Σημείωση</th><th></th></tr></thead><tbody id="oh_rows"></tbody></table></div>
      </details>
      <details><summary>Οχημάτων</summary>
        <div class="scroll-x"><table><thead><tr><th>Ημ/νία</th><th>Όχημα</th><th>Ποιος</th><th>Κατάσταση</th><th>Ποσό</th><th>Σημείωση</th></tr></thead><tbody id="veh_exp_rows"></tbody></table></div>
      </details>
    </div>
  </div>`));
  const ohRows = document.getElementById('oh_rows');
  for(const e of state.expenses.filter(x=> x.type==='overhead')){
    ohRows.append(el(`<tr><td>${dfmt(e.date)}</td><td>${e.category||''}</td><td>${e.whoPaid}</td><td>${e.status}</td><td>${fmt.format(e.amount)}</td><td>${e.note||''}</td>
    <td><button class="btn danger" onclick="delExpense('${e.id}')">Διαγραφή</button></td></tr>`));
  }
  const vr = document.getElementById('veh_exp_rows');
  for(const e of state.expenses.filter(x=> x.type==='vehicle')){
    const v = state.vehicles.find(xx=> xx.id===e.vehicleId);
    vr.append(el(`<tr><td>${dfmt(e.date)}</td><td>${v? v.title:'—'}</td><td>${e.whoPaid}</td><td>${e.status}</td><td>${fmt.format(e.amount)}</td><td>${e.note||''}</td></tr>`));
  }
}
function addOverhead(){
  const category = document.getElementById('oh_cat').value;
  const whoPaid = document.getElementById('oh_who').value;
  const status = document.getElementById('oh_status').value;
  const amount = Number(document.getElementById('oh_amount').value||0);
  const date = document.getElementById('oh_date').value || new Date().toISOString().slice(0,10);
  const note = document.getElementById('oh_note').value;
  const e = {id:uid(), type:'overhead', vehicleId:null, category, whoPaid, status, amount, note, date, dueDate:''};
  state.expenses.unshift(e);
  if(status==='paid' && whoPaid===getOwner()){
    state.freeHistory.unshift({id:uid(), date, kind:'expense', amount:-amount, note:`Overhead: ${category}`, ref:e.id});
  }
  save(); draw();
}

// -------- Sold
function viewSold(host){
  const sold = state.vehicles.filter(v=> v.sale?.price>0);
  host.append(el(`<div class="card scroll-x">
    <table><thead><tr><th>Τίτλος</th><th>Αγορά</th><th>Έξοδα</th><th>Πώληση</th><th>Μικτό</th><th>Υπόλοιπο (δικό σου)</th><th>Δράσεις</th></tr></thead><tbody id="sold_rows"></tbody></table></div>`));
  const tb = document.getElementById('sold_rows');
  for(const v of sold){
    const t = vehicleTotals(v);
    const row = el(`<tr>
      <td>${v.title}</td>
      <td>${fmt.format(v.purchasePrice)}</td>
      <td>${fmt.format(t.totalExpenses)}</td>
      <td>${fmt.format(v.sale.price)}<div class="muted">${dfmt(v.sale.date)}</div></td>
      <td>${fmt.format(t.grossProfit)}</td>
      <td>${fmt.format(t.yourCapitalBalance + t.yourProfitBalance)}</td>
      <td class="flex">
        <button class="btn" onclick="unsell('${v.id}')">Μη πωλημένο</button>
        <button class="btn" onclick="openVehHistory('${v.id}')">Ιστορικό</button>
        <button class="btn danger" onclick="openDeleteVehicle('${v.id}')">Διαγραφή</button>
      </td>
    </tr>`);
    tb.append(row);
  }
}
function unsell(id){
  const v = state.vehicles.find(x=> x.id===id); if(!v) return;
  v.sale.price = 0; v.sale.date=''; v.sale.settled=false;
  save(); draw();
}

// -------- Old Debts
function viewOldDebts(host){
  host.append(el(`<div class="row">
    <div class="card">
      <h3>Υποθέσεις παλαιών οφειλών (κεφάλαιο/κέρδος ανά συνεργάτη)</h3>
      <div class="grid-3">
        <div><label>Τίτλος</label><input id="od_title"></div>
        <div><label>Συνεργάτης</label><select id="od_name">${state.settings.partners.map(n=> `<option>${n}</option>`)}</select></div>
        <div><label>Κεφάλαιο που οφείλεται</label><input id="od_cap" type="number"></div>
      </div>
      <div class="grid-3">
        <div><label>Κέρδος που οφείλεται</label><input id="od_prof" type="number"></div>
        <div><label>Σημείωση</label><input id="od_note"></div>
        <div style="align-self:end"><button class="btn primary" onclick="addOldDebt()">Προσθήκη</button></div>
      </div>
      <div class="space"></div>
      <div class="scroll-x"><table><thead><tr><th>Τίτλος</th><th>Συν.</th><th>Cap owed</th><th>Profit owed</th><th>Είσπρ.</th><th></th></tr></thead><tbody id="od_rows"></tbody></table></div>
    </div>
    <div class="card">
      <h3>Χρωστάνε προς εμένα (πρόχειρα)</h3>
      <div class="grid-3">
        <div><label>Όνομα</label><input id="ow_name"></div>
        <div><label>Ποσό</label><input id="ow_amt" type="number"></div>
        <div><label>Σημείωση</label><input id="ow_note"></div>
      </div>
      <div class="flex right"><button class="btn primary" onclick="addOwed()">Προσθήκη</button></div>
      <div class="space"></div>
      <div class="scroll-x"><table><thead><tr><th>Όνομα</th><th>Ποσό</th><th>Σημείωση</th><th></th></tr></thead><tbody id="ow_rows"></tbody></table></div>
    </div>
  </div>`));
  const tbody = document.getElementById('od_rows');
  for(const c of state.oldDebts.cases){
    const recSum = sum((c.receipts||[]).map(r=> Number(r.amount||0)));
    tbody.append(el(`<tr><td>${c.title}</td><td>${c.name}</td><td>${fmt.format(c.capitalOwed)}</td>
      <td>${fmt.format(c.profitOwed)}</td><td>${fmt.format(recSum)}</td>
      <td><button class="btn" onclick="openOldReceipt('${c.id}')">Είσπραξη</button> <button class="btn danger" onclick="delOld('${c.id}')">Διαγραφή</button></td></tr>`));
  }
  const ow = document.getElementById('ow_rows');
  for(const r of state.oldDebts.owedToMe){
    ow.append(el(`<tr><td>${r.name}</td><td>${fmt.format(r.amount)}</td><td>${r.note||''}</td>
      <td><button class="btn danger" onclick="delOwed('${r.id}')">Εξόφληση</button></td></tr>`));
  }
}
function addOldDebt(){
  const title = document.getElementById('od_title').value;
  const name = document.getElementById('od_name').value;
  const capitalOwed = Number(document.getElementById('od_cap').value||0);
  const profitOwed  = Number(document.getElementById('od_prof').value||0);
  const note = document.getElementById('od_note').value;
  const c = {id:uid(), title, name, capitalOwed, profitOwed, note, receipts:[]};
  state.oldDebts.cases.unshift(c); save(); draw();
}
function openOldReceipt(id){
  const c = state.oldDebts.cases.find(x=> x.id===id); if(!c) return;
  openModal(`<h3>Είσπραξη — ${c.title}</h3>
    <div class="grid-3">
      <div><label>Τύπος</label><select id="or_type"><option value="capital">Capital</option><option value="profit">Profit</option></select></div>
      <div><label>Ποσό</label><input id="or_amt" type="number"></div>
      <div><label>Ημ/νία</label><input id="or_date" type="date"></div>
    </div>
    <div class="grid-3">
      <div><label>Προορισμός</label><select id="or_dest">
        <option value="free">Free</option>
        <option value="vehicle">Άλλο όχημα (Δέσμευση)</option>
        <option value="split">Split</option></select></div>
      <div><label>Σημείωση</label><input id="or_note"></div>
      <div></div>
    </div>
    <div class="flex right"><button class="btn primary" onclick="saveOldReceipt('${id}')">Καταχώριση</button></div>`);
}
function saveOldReceipt(id){
  const c = state.oldDebts.cases.find(x=> x.id===id); if(!c) return;
  const type = document.getElementById('or_type').value;
  const amount = Number(document.getElementById('or_amt').value||0);
  const date = document.getElementById('or_date').value || new Date().toISOString().slice(0,10);
  const dest = document.getElementById('or_dest').value;
  const note = document.getElementById('or_note').value;
  const rec = {id:uid(), owner:getOwner(), type, amount, date, dest, note, details:{}};
  c.receipts.unshift(rec);
  if(dest==='free'){
    state.freeHistory.unshift({id:uid(), date, kind:'receipt', amount, note:`OldDebt: ${c.title}`, ref:rec.id});
  }
  save(); closeModal(); draw();
}
function delOld(id){ state.oldDebts.cases = state.oldDebts.cases.filter(x=> x.id!==id); save(); draw(); }
function addOwed(){
  const name = document.getElementById('ow_name').value;
  const amount = Number(document.getElementById('ow_amt').value||0);
  const note = document.getElementById('ow_note').value;
  state.oldDebts.owedToMe.unshift({id:uid(), name, amount, note});
  save(); draw();
}
function delOwed(id){ state.oldDebts.owedToMe = state.oldDebts.owedToMe.filter(x=> x.id!==id); save(); draw(); }

// -------- Trash
function viewTrash(host){
  host.append(el(`<div class="row">
    <div class="card"><h3>Οχήματα (Διεγραμμένα)</h3>
      <div class="scroll-x"><table><thead><tr><th>Τίτλος</th><th>Αγορά</th><th>Πώληση</th><th></th></tr></thead><tbody id="trash_v"></tbody></table></div>
    </div>
    <div class="card"><h3>Έξοδα (Διεγραμμένα)</h3>
      <div class="scroll-x"><table><thead><tr><th>Ημ/νία</th><th>Τύπος</th><th>Ποσό</th><th>Σημείωση</th><th></th></tr></thead><tbody id="trash_e"></tbody></table></div>
    </div>
  </div>`));
  const tv=document.getElementById('trash_v');
  for(const v of state.trash.vehicles){
    tv.append(el(`<tr><td>${v.title}</td><td>${fmt.format(v.purchasePrice)}</td><td>${v.sale?.price?fmt.format(v.sale.price):'-'}</td>
      <td><button class="btn" onclick="restoreVehicle('${v.id}')">Επαναφορά</button>
      <button class="btn danger" onclick="purgeVehicle('${v.id}')">Οριστική</button></td></tr>`));
  }
  const te=document.getElementById('trash_e');
  for(const e of state.trash.expenses){
    te.append(el(`<tr><td>${dfmt(e.date)}</td><td>${e.type}</td><td>${fmt.format(e.amount)}</td><td>${e.note||''}</td>
      <td><button class="btn" onclick="restoreExpense('${e.id}')">Επαναφορά</button>
      <button class="btn danger" onclick="purgeExpense('${e.id}')">Οριστική</button></td></tr>`));
  }
}
function restoreVehicle(id){
  const idx = state.trash.vehicles.findIndex(x=> x.id===id); if(idx<0) return;
  state.vehicles.unshift(state.trash.vehicles[idx]); state.trash.vehicles.splice(idx,1);
  save(); draw();
}
function purgeVehicle(id){ state.trash.vehicles = state.trash.vehicles.filter(x=> x.id!==id); save(); draw(); }
function restoreExpense(id){
  const idx = state.trash.expenses.findIndex(x=> x.id===id); if(idx<0) return;
  state.expenses.unshift(state.trash.expenses[idx]); state.trash.expenses.splice(idx,1);
  save(); draw();
}
function purgeExpense(id){ state.trash.expenses = state.trash.expenses.filter(x=> x.id!==id); save(); draw(); }

// -------- Modal helpers
function openModal(html){
  document.getElementById('modalBody').innerHTML = html;
  document.getElementById('modal').showModal();
}
function closeModal(){ document.getElementById('modal').close(); }

// -------- Import/Export/PDF
document.getElementById('btnImport').onclick = ()=>{
  const inp = el(`<input type="file" accept="application/json">`);
  inp.onchange = (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(reader.result);
        state = migrate(data); save(); draw();
      }catch(err){ showError('Import failed: '+err.message,'',0,0,err.stack); }
    };
    reader.readAsText(file);
  };
  inp.click();
};
document.getElementById('btnExport').onclick = ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = el(`<a download="center-car-v35.json"></a>`);
  a.href = url; a.click(); URL.revokeObjectURL(url);
};
document.getElementById('btnPDF').onclick = ()=>{ window.print(); };

// -------- Init
draw();
</script>
</body>
</html>
